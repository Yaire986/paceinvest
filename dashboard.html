<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ChargePace</title>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Local CSS -->
    <link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body class="dashboard-page">

    <!-- Left Sidebar for Desktop View -->
    <nav class="sidebar-nav">
        <a href="#" data-target="home-content" class="sidebar-logo">CHARGEPACE</a>
        <div class="sidebar-links">
            <a href="#" data-target="home-content" class="sidebar-link active"><i class="fa-solid fa-house"></i><span>Dashboard</span></a>
            <a href="#" data-target="my-ports-content" class="sidebar-link"><i class="fa-solid fa-charging-station"></i><span>My Ports</span></a>
            <a href="#" data-target="wallet-content" class="sidebar-link"><i class="fa-solid fa-wallet"></i><span>Wallet</span></a>
            <a href="#" data-target="invest-content" class="sidebar-link"><i class="fa-solid fa-chart-pie"></i><span>Invest</span></a>
            <a href="#" data-target="profile-content" class="sidebar-link"><i class="fa-solid fa-user"></i><span>Profile</span></a>
        </div>
        <div class="sidebar-logout"><button id="logout-button-desktop"><i class="fa-solid fa-arrow-right-from-bracket"></i><span>Log Out</span></button></div>
    </nav>

        <!-- Main Content Area -->
    <div class="main-content">
        <div class="page-content-container">
                         <!-- ========= HOME / DASHBOARD CONTENT ========= -->
            <div id="home-content" class="page-content active">
                <header class="mobile-header"><div class="user-info"><p>Welcome Back,</p><h1 id="user-name-mobile">Loading...</h1></div><button id="logout-button-mobile" class="logout-icon"><i class="fa-solid fa-arrow-right-from-bracket"></i></button></header>
                <header class="desktop-header"><h1>Dashboard</h1><div class="user-info"><span>Welcome, <span id="user-name-desktop">Loading...</span></span></div></header>
                <main class="dashboard-grid"><section class="card balance-card">
    <div class="balance-header">
        <p>Available Balance</p> <!-- Text changed here -->
    </div>
    <div class="balance-amount">
        <span>$</span><p>0.00</p>
    </div>
    <div class="balance-subtitle">
        <i class="fa-solid fa-arrow-trend-up"></i>
        <p>$0.00 earnings this month</p>
    </div>
    <div class="balance-actions">
        <button class="btn btn-primary"><i class="fa-solid fa-arrow-down"></i> Withdraw</button>
        <button class="btn btn-secondary deposit-btn"><i class="fa-solid fa-plus"></i> Deposit</button>
    </div>
</section>
<section class="card chart-card">
    <div class="chart-header">
        <h3 id="chart-total-earnings">$0.00</h3>
        <p id="chart-comparison" class="positive">+ $0.00 from last month</p>
    </div>
    <div id="earnings-chart"></div> <!-- This is our new chart container -->
    <div class="chart-timespan">
        <button class="timespan-btn active" data-range="30D">30D</button>
        <button class="timespan-btn" data-range="6M">6M</button>
        <button class="timespan-btn" data-range="1Y">1Y</button>
    </div>
</section>
<section class="card activity-card"><h3>Recent Activity</h3><ul class="activity-list"><li style="padding: 20px 0; text-align: center; color: var(--text-light);">Loading activity...</li></ul></section></main>
            </div>

            <!-- ========= MY PORTS CONTENT ========= -->
            <div id="my-ports-content" class="page-content hidden">
                <header class="mobile-header"><div class="user-info"><h1>My Charging Ports</h1></div></header>
                <header class="desktop-header"><h1>My Charging Ports</h1></header>
                <main><div class="ports-list"></div></main>
            </div>

            <!-- ========= INVEST CONTENT ========= -->
            <div id="invest-content" class="page-content hidden">
                <header class="mobile-header"><div class="user-info"><h1>Invest</h1></div></header>
                <header class="desktop-header"><h1>Invest in a New Port</h1></header>
                <main class="invest-wizard-container">
                    <div id="invest-step-1" class="invest-step active">
                        <div class="step-header"><h2>Step 1: Choose Your Investment Package</h2></div>
                        <div class="package-selection-grid">
                            <div class="package-card">
                                <img src="images/standard-charger.png" alt="Standard EV Charger" class="package-image">
                                <div class="package-details">
                                    <h3>Standard Port</h3>
                                    <p class="package-price">$1,299</p>
                                    <ul class="package-features">
                                        <li><i class="fa-solid fa-check"></i> Expert Site Selection Included</li>
                                        <li><i class="fa-solid fa-check"></i> Ideal for Steady Returns</li>
                                        <li><i class="fa-solid fa-check"></i> Fully Managed by ChargePace</li>
                                    </ul>
                                    <button class="btn btn-primary select-package-btn" data-package="Standard Port" data-price="1299">Select Package</button>
                                </div>
                            </div>
                            <div class="package-card">
                                <img src="images/pro-charger.png" alt="Pro EV Charger" class="package-image">
                                <div class="package-details">
                                    <h3>High-Traffic Pro Port</h3>
                                    <p class="package-price">$2,499</p>
                                    <ul class="package-features">
                                        <li><i class="fa-solid fa-check"></i> Prime High-Traffic Site Selection</li>
                                        <li><i class="fa-solid fa-check"></i> Maximized Earnings Potential</li>
                                        <li><i class="fa-solid fa-check"></i> Fully Managed by ChargePace</li>
                                    </ul>
                                    <button class="btn btn-primary select-package-btn" data-package="High-Traffic Pro Port" data-price="2499">Select Package</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Other invest steps remain the same -->
                    <div id="invest-step-2" class="invest-step hidden">
                        <div class="step-header"><h2>Step 2: Choose Your Investment Region</h2><p class="step-subtitle">Our experts will select the optimal high-traffic site for your new port within the region you choose.</p></div>
                        <div class="card"><div class="form-group"><label for="region-select">Select a Country</label><select id="region-select"><option value="">Please select a country...</option><optgroup label="North America"><option value="United States">United States</option><option value="Canada">Canada</option><option value="Mexico">Mexico</option><option value="Puerto Rico">Puerto Rico</option></optgroup><optgroup label="Europe"><option value="Austria">Austria</option><option value="Belgium">Belgium</option><option value="Denmark">Denmark</option><option value="Finland">Finland</option><option value="France">France</option><option value="Germany">Germany</option><option value="Hungary">Hungary</option><option value="Iceland">Iceland</option><option value="Italy">Italy</option><option value="Spain">Spain</option><option value="Sweden">Sweden</option><option value="United Kingdom">United Kingdom</option></optgroup><optgroup label="Asia"><option value="China">China</option><option value="Japan">Japan</option><option value="Hong Kong">Hong Kong</option><option value="Israel">Israel</option><option value="Jordan">Jordan</option><option value="Qatar">Qatar</option><option value="United Arab Emirates">United Arab Emirates</option></optgroup><optgroup label="Oceania"><option value="Australia">Australia</option><option value="New Zealand">New Zealand</option></optgroup><optgroup label="Africa"><option value="Morocco">Morocco</option></optgroup></select></div><div class="form-navigation"><button class="btn btn-secondary invest-nav-btn" data-target-step="1">Back</button><button class="btn btn-primary invest-nav-btn" data-target-step="3">Next</button></div></div>
                    </div>
                    <div id="invest-step-3" class="invest-step hidden">
                        <div class="step-header"><h2>Step 3: Review and Confirm</h2></div>
                        <div class="card"><h3>Order Summary</h3><div class="summary-details"><div class="summary-item"><span>Package</span><strong id="summary-package-name">Loading...</strong></div><div class="summary-item"><span>Investment Region</span><strong id="summary-region">Loading...</strong></div><div class="summary-item"><span>Hardware Cost</span><span id="summary-hardware-cost">$0.00</span></div><div class="summary-item"><span>Siting & Installation Fee</span><span id="summary-fee-cost">$0.00</span></div><div class="summary-item total"><span>Total Investment</span><strong id="summary-total-cost">$0.00</strong></div></div><div class="what-happens-next"><h4>What Happens Next?</h4><p>After payment, our team will select a profitable location in your chosen region. We handle all installation and maintenance. You can track your new port's status on the 'My Ports' page. Sit back and watch your earnings grow!</p></div><div class="terms-agreement"><input type="checkbox" id="terms-checkbox"><label for="terms-checkbox">I have read and agree to the <a href="#" target="_blank">Investment Terms & Conditions</a>.</label></div><div class="form-navigation"><button class="btn btn-secondary invest-nav-btn" data-target-step="2">Back</button><button id="confirm-and-pay-btn" class="btn btn-primary">Confirm & Proceed to Payment</button></div></div>
                    </div>
                    <div id="invest-step-4" class="invest-step hidden">
                        <div class="card success-message-card"><div class="step-title-wrapper"><i class="fa-solid fa-hourglass-half success-icon" style="color: #f39c12;"></i><h2>Payment Processing</h2></div><p>Your order has been submitted. Please complete the transaction in the payment window. Once payment is confirmed, an admin will approve your investment.</p><button class="btn btn-primary invest-nav-btn" data-target-page="my-ports-content" style="margin-top: 1.5rem;">I Have Made The Payment</button></div>
                    </div>
                </main>
            </div>

            <!-- ========= WALLET CONTENT ========= -->
            <div id="wallet-content" class="page-content hidden">
                <header class="mobile-header"><div class="user-info"><h1>Wallet</h1></div></header>
                <header class="desktop-header"><h1>Wallet</h1></header>
                <main>
                    <!-- MODIFICATION: Wrapper for the new top grid layout on desktop -->
                    <div class="wallet-layout-top">
                        <div class="card wallet-summary-card">
                            <div class="wallet-balance-info">
                                <span class="port-label">Available Balance</span>
                                <div class="balance-amount">
                                    <span>$</span><p id="wallet-balance">0.00</p>
                                </div>
                            </div>
                            <div class="wallet-actions">
                                <button id="wallet-withdraw-btn" class="btn btn-secondary"><i class="fa-solid fa-arrow-down"></i> Withdraw</button>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Linked Accounts</h3>
                                <button id="add-account-btn" class="btn btn-sm btn-outline">Add Account</button>
                            </div>
                            <div class="card-content">
                                <ul id="linked-accounts-list" class="linked-accounts-list"></ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Transaction History</h3>
                        </div>
                        <div class="card-content" style="padding: 0;">
                            <ul id="wallet-transaction-list" class="activity-list"></ul>
                        </div>
                    </div>
                </main>
            </div>
            
            <!-- ========= PROFILE & REFERRALS CONTENT ========= -->
            <div id="profile-content" class="page-content hidden">
                <header class="mobile-header"><div class="user-info"><h1>Profile</h1></div></header>
                <header class="desktop-header"><h1>Profile</h1></header>
                <main>
                    <div class="profile-tabs">
                        <button class="profile-tab-link active" data-target="profile-settings-content">Settings</button>
                        <button class="profile-tab-link" data-target="profile-referrals-content">Referrals</button>
                    </div>

                    <div class="profile-tab-content">
                        <div id="profile-settings-content">
                            <!-- MODIFICATION: Wrapper for profile cards to control spacing -->
                            <div class="profile-cards-wrapper">
                                <div class="card">
                                    <form id="profile-form">
                                        <div class="profile-picture-container">
                                            <div class="profile-picture-wrapper"><img src="https://i.stack.imgur.com/34AD2.jpg" alt="Profile Picture" class="profile-picture" id="profile-picture-img"><label for="profile-picture-upload" class="profile-picture-upload-btn"><i class="fa-solid fa-camera"></i></label><input type="file" id="profile-picture-upload" accept="image/*" style="display: none;"></div>
                                        </div>
                                        <h2>Personal Information</h2>
                                        <div class="profile-grid">
                                            <div class="form-group"><label for="profile-first-name">First Name</label><input type="text" id="profile-first-name"></div>
                                            <div class="form-group"><label for="profile-last-name">Last Name</label><input type="text" id="profile-last-name"></div>
                                        </div>
                                        <div class="form-group"><label for="profile-email">Email Address</label><input type="email" id="profile-email" readonly></div>
                                        <h2 style="margin-top: 2rem;">Address Information</h2>
                                        <div class="form-group"><label for="profile-address">Street Address</label><input type="text" id="profile-address"></div>
                                        <div class="profile-grid">
                                            <div class="form-group"><label for="profile-city">City</label><input type="text" id="profile-city"></div>
                                            <div class="form-group"><label for="profile-state">State / Province</label><input type="text" id="profile-state"></div>
                                            <div class="form-group"><label for="profile-zip">ZIP / Postal Code</label><input type="text" id="profile-zip"></div>
                                            <div class="form-group"><label for="profile-country">Country</label><input type="text" id="profile-country" readonly></div>
                                        </div>
                                        <div class="modal-actions" style="border-top: none; padding-top: 0;"><button type="submit" class="btn btn-primary">Save Changes</button></div>
                                    </form>
                                </div>
                                <div class="card">
                                    <h2>KYC Verification</h2>
                                    <div id="kyc-verified-section" class="hidden" style="text-align: center; padding: 1rem;"><p style="font-weight: 500;">Your ID has been verified.</p><span class="kyc-status-badge verified">Verified</span></div>
                                    <div id="kyc-pending-section" class="hidden" style="text-align: center; padding: 1rem;"><p style="font-weight: 500;">Your ID is currently under review.</p><span class="kyc-status-badge pending">Pending</span></div>
                                    <div id="kyc-upload-section"><p>Please upload a clear image of a government-issued ID (e.g., Driver's License, Passport).</p><div class="kyc-upload-area"><i class="fa-solid fa-id-card"></i><label for="kyc-document-upload" class="btn btn-secondary">Choose File</label><input type="file" id="kyc-document-upload" accept="image/*" style="display: none;"><p id="kyc-file-name" style="margin-top: 1rem;"></p></div><div class="modal-actions" style="border-top: none; padding-top: 1rem;"><button id="submit-kyc-btn" class="btn btn-primary">Upload for Verification</button></div></div>
                                </div>
                            </div>
                        </div>
                        <div id="profile-referrals-content" class="hidden">
                           <!-- Referrals content remains the same -->
                           <div class="referral-stats-grid"><div class="stat-card"><p id="referral-count" class="stat-value">0</p><p class="stat-label">Total Referrals</p></div><div class="stat-card"><p id="referral-earnings" class="stat-value">$0.00</p><p class="stat-label">Total Earnings</p></div></div><div class="card"><h2>Your Referral Link</h2><p>Share your referral link with friends and earn 10% of their profits!</p><div class="referral-link-container"><input type="text" id="referral-link-input" readonly><button id="copy-referral-link-btn" class="btn btn-primary">Copy</button></div></div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- ALL MODALS -->
    <div id="port-details-modal" class="modal-overlay hidden"><div class="modal-content"><div class="modal-header"><div><h2 id="modal-port-location">Port Location Name</h2><p id="modal-port-id" class="port-id">#PORT-ID</p></div><button class="modal-close-button">&times;</button></div><div class="modal-info-grid"><div class="port-info-item"><span class="port-label">Status</span><span id="modal-port-status" class="port-status">Loading...</span></div><div class="port-info-item"><span class="port-label">Activation Date</span><span id="modal-activation-date" class="port-value">Loading...</span></div><div class="port-info-item"><span class="port-label">Monthly Earnings</span><span id="modal-monthly-earnings" class="port-value">Loading...</span></div><div class="port-info-item"><span class="port-label">Lifetime Earnings</span><span id="modal-lifetime-earnings" class="port-value">Loading...</span></div><div class="port-info-item"><span class="port-label">Utilization</span><span id="modal-utilization" class="port-value">Loading...</span></div></div></div></div>
    
    <div id="payment-modal" class="modal-overlay hidden" data-payment-context="deposit" data-payment-method="">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="payment-modal-title">Make a Deposit</h2>
                <button class="modal-close-button">&times;</button>
            </div>
            <div class="form-group">
                <label for="payment-amount">Amount (USD)</label>
                <input type="number" id="payment-amount" placeholder="Enter amount (e.g., 500)">
            </div>
            <div class="payment-options">
                <button id="pay-with-crypto" class="btn btn-secondary"><i class="fa-brands fa-bitcoin"></i>&nbsp; Pay With Crypto</button>
                <button id="pay-with-card" class="btn btn-secondary"><i class="fa-solid fa-credit-card"></i>&nbsp; Pay With Card</button>
            </div>
            <div id="crypto-payment-section" class="payment-section hidden">
                <p class="payment-instruction">You will be redirected to our secure partner NowPayments to complete your transaction.</p>
                <button id="proceed-to-pay-crypto" class="btn btn-primary">Proceed to Pay</button>
            </div>
            <div id="card-payment-section" class="payment-section hidden">
                <p class="payment-instruction">Copy the BTC address below, then click 'Proceed to Pay' to complete your purchase via Simplex.</p>
                <div class="form-group">
                    <label for="btc-address-display">BTC Deposit Address</label>
                    <div class="address-container">
                        <input type="text" id="btc-address-display" readonly>
                        <button id="copy-btc-address-btn" class="btn btn-secondary">Copy</button>
                    </div>
                </div>
                <button id="proceed-to-pay-card" class="btn btn-primary">Proceed to Pay</button>
            </div>
        </div>
    </div>

    <div id="add-account-modal" class="modal-overlay hidden"><div class="modal-content"><div class="modal-header"><h2>Add New Bank Account</h2><button class="modal-close-button">&times;</button></div><form id="add-account-form"><div class="form-group"><label for="add-bank-name">Bank Name</label><input type="text" id="add-bank-name" placeholder="e.g., Chase Bank" required></div><div class="form-group"><label for="add-account-holder-name">Account Holder Name</label><input type="text" id="add-account-holder-name" placeholder="e.g., John Doe" required></div><div class="form-group"><label for="add-account-number">Account Number</label><input type="text" id="add-account-number" placeholder="Enter full account number" required></div><div class="form-group"><label for="add-routing-number">Routing Number</label><input type="text" id="add-routing-number" placeholder="Enter routing number" required></div><div class="form-group"><label for="add-account-type">Account Type</label><select id="add-account-type" required><option value="Checking">Checking</option><option value="Savings">Savings</option></select></div><div class="toggle-switch-container"><label for="set-primary-account-toggle">Set as primary account</label><label class="toggle-switch"><input type="checkbox" id="set-primary-account-toggle"><span class="toggle-slider"></span></label></div><div class="modal-actions"><button type="submit" id="submit-add-account" class="btn btn-primary">Add Account</button></div></form></div></div>
    <div id="view-account-modal" class="modal-overlay hidden"><div class="modal-content"><div class="modal-header"><h2>Account Details</h2><button class="modal-close-button">&times;</button></div><div class="view-account-details"><div class="detail-item"><span class="detail-label">Bank Name</span><span id="view-bank-name" class="detail-value"></span></div><div class="detail-item"><span class="detail-label">Account Holder</span><span id="view-account-holder" class="detail-value"></span></div><div class="detail-item"><span class="detail-label">Account Number</span><span id="view-account-number" class="detail-value"></span></div><div class="detail-item"><span class="detail-label">Routing Number</span><span id="view-routing-number" class="detail-value"></span></div><div class="detail-item"><span class="detail-label">Account Type</span><span id="view-account-type" class="detail-value"></span></div><div class="detail-item"><span class="detail-label">Primary</span><span id="view-is-primary" class="detail-value"></span></div></div><div class="modal-actions"><button id="delete-account-btn" class="btn btn-danger"><i class="fa-solid fa-trash"></i> Delete Account</button></div></div></div>
    
    <!-- ================== HTML CHANGE IS HERE ================== -->
    <div id="withdraw-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Withdraw Funds</h2>
                <button class="modal-close-button">&times;</button>
            </div>
            <!-- This new 'modal-body' div will contain all the scrolling form elements -->
            <div class="modal-body">
                <div class="form-group">
                    <label for="withdraw-amount">Amount</label>
                    <div class="amount-input-group">
                        <input type="number" id="withdraw-amount" placeholder="0.00">
                        <div class="balance-display">Available: $<span id="max-withdraw-balance">0.00</span></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="withdraw-method">Withdrawal Method</label>
                    <select id="withdraw-method">
                        <option value="">Select withdrawal method</option>
                        <option value="crypto">Crypto Withdrawal</option>
                        <option value="bank">Bank Transfer</option>
                    </select>
                </div>
                <div id="crypto-withdrawal-section" class="withdrawal-section hidden">
                    <div class="form-group">
                        <label for="crypto-currency">Select Cryptocurrency</label>
                        <select id="crypto-currency">
                            <option value="BTC">Bitcoin (BTC)</option>
                            <option value="USDT">Tether (USDT)</option>
                            <option value="ETH">Ethereum (ETH)</option>
                            <option value="LTC">Litecoin (LTC)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="crypto-address">Wallet Address</label>
                        <input type="text" id="crypto-address" placeholder="Enter your wallet address">
                    </div>
                </div>
                <div id="bank-withdrawal-section" class="withdrawal-section hidden">
                    <div class="form-group">
                        <label for="bank-name">Bank Name</label>
                        <input type="text" id="bank-name" placeholder="Enter your bank name">
                    </div>
                    <div class="form-group">
                        <label for="account-holder-name">Account Name</label>
                        <input type="text" id="account-holder-name" placeholder="Enter account name">
                        <p class="input-hint">Name must match your profile name.</p>
                    </div>
                    <div class="form-group">
                        <label for="account-number">Account Number</label>
                        <input type="text" id="account-number" placeholder="Enter account number">
                    </div>
                    <div class="form-group">
                        <label for="routing-number">Routing Number</label>
                        <input type="text" id="routing-number" placeholder="Enter routing number (if required)">
                    </div>
                </div>
                <div class="form-group">
                    <label for="withdrawal-code">Withdrawal Code</label>
                    <input type="text" id="withdrawal-code" placeholder="Enter 6-digit withdrawal code" maxlength="6">
                    <p class="input-hint">Contact support if you don't have a withdrawal code.</p>
                </div>
            </div> <!-- End of the new 'modal-body' div -->
            <div class="modal-actions">
                <button id="submit-withdrawal" class="btn btn-primary">Submit Withdrawal</button>
            </div>
        </div>
    </div>
    <!-- ================== END OF HTML CHANGE ================== -->

    <!-- Bottom Navigation for Mobile View -->
    <nav class="bottom-nav">
        <a href="#" data-target="home-content" class="nav-link active"><i class="fa-solid fa-house"></i><span>Home</span></a>
        <a href="#" data-target="my-ports-content" class="nav-link"><i class="fa-solid fa-charging-station"></i><span>My Ports</span></a>
        <a href="#" data-target="invest-content" class="nav-link nav-link-primary"><i class="fa-solid fa-plus"></i></a>
        <a href="#" data-target="wallet-content" class="nav-link"><i class="fa-solid fa-wallet"></i><span>Wallet</span></a>
        <a href="#" data-target="profile-content" class="nav-link"><i class="fa-solid fa-user"></i><span>Profile</span></a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- Firebase and Auth Logic -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
      const firebaseConfig = { apiKey: "AIzaSyDxAuX5hEWOuYdeGSvQHxhMlb9hyRZTNYw", authDomain: "twc2-95e6e.firebaseapp.com", projectId: "twc2-95e6e", storageBucket: "twc2-95e6e.appspot.com", messagingSenderId: "648663487938", appId: "1:648663487938:web:f466fd8fdd893bdaeef25b" };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
    </script>
    
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 1. ELEMENT SELECTORS ---
    const body = document.querySelector('body');
    const userNameDesktop = document.getElementById('user-name-desktop');
    const userNameMobile = document.getElementById('user-name-mobile');
    const logoutButtonDesktop = document.getElementById('logout-button-desktop');
    const logoutButtonMobile = document.getElementById('logout-button-mobile');
    const balanceAmountEl = document.querySelector('#home-content .balance-amount p');
    const balanceSubtitleEl = document.querySelector('.balance-subtitle p');
    const depositButtons = document.querySelectorAll('.deposit-btn');
    const activityListEl = document.querySelector('#home-content .activity-list');
    const portsListEl = document.querySelector('.ports-list');
    const navLinks = document.querySelectorAll('.nav-link, .sidebar-link');
    const pageContents = document.querySelectorAll('.page-content');
    const walletBalanceEl = document.getElementById('wallet-balance');
    const linkedAccountsListEl = document.getElementById('linked-accounts-list');
    const walletTransactionListEl = document.getElementById('wallet-transaction-list');
    const walletWithdrawBtn = document.getElementById('wallet-withdraw-btn');
    const addAccountBtn = document.getElementById('add-account-btn');
    const addAccountModal = document.getElementById('add-account-modal');
    const addAccountForm = document.getElementById('add-account-form');
    const setPrimaryAccountCheckbox = document.getElementById('set-primary-account-toggle');
    const viewAccountModal = document.getElementById('view-account-modal');
    const viewBankName = document.getElementById('view-bank-name');
    const viewAccountHolder = document.getElementById('view-account-holder');
    const viewAccountNumber = document.getElementById('view-account-number');
    const viewRoutingNumber = document.getElementById('view-routing-number');
    const viewAccountType = document.getElementById('view-account-type');
    const viewIsPrimary = document.getElementById('view-is-primary');
    const deleteAccountBtn = document.getElementById('delete-account-btn');
    const allModalCloseButtons = document.querySelectorAll('.modal-close-button');
    const allModalOverlays = document.querySelectorAll('.modal-overlay');
    const withdrawModal = document.getElementById('withdraw-modal');
    const withdrawAmountInput = document.getElementById('withdraw-amount');
    const maxWithdrawBalanceEl = document.getElementById('max-withdraw-balance');
    const withdrawMethodSelect = document.getElementById('withdraw-method');
    const cryptoWithdrawalSection = document.getElementById('crypto-withdrawal-section');
    const bankWithdrawalSection = document.getElementById('bank-withdrawal-section');
    const withdrawalCodeInput = document.getElementById('withdrawal-code');
    const submitWithdrawalBtn = document.getElementById('submit-withdrawal');
    const portModal = document.getElementById('port-details-modal');
    const paymentModal = document.getElementById('payment-modal');
    const paymentModalTitle = document.getElementById('payment-modal-title');
    const paymentAmountInput = document.getElementById('payment-amount');
    const payWithCryptoBtn = document.getElementById('pay-with-crypto');
    const payWithCardBtn = document.getElementById('pay-with-card');
    const cryptoPaymentSection = document.getElementById('crypto-payment-section');
    const cardPaymentSection = document.getElementById('card-payment-section');
    const proceedToPayCryptoBtn = document.getElementById('proceed-to-pay-crypto');
    const proceedToPayCardBtn = document.getElementById('proceed-to-pay-card');
    const btcAddressDisplay = document.getElementById('btc-address-display');
    const investSteps = document.querySelectorAll('.invest-step');
    const selectPackageBtns = document.querySelectorAll('.select-package-btn');
    const investNavBtns = document.querySelectorAll('.invest-nav-btn');
    const confirmAndPayBtn = document.getElementById('confirm-and-pay-btn');
    const termsCheckbox = document.getElementById('terms-checkbox');
    const profileForm = document.getElementById('profile-form');
    const profilePictureImg = document.getElementById('profile-picture-img');
    const profilePictureUpload = document.getElementById('profile-picture-upload');
    const kycUploadSection = document.getElementById('kyc-upload-section');
    const kycPendingSection = document.getElementById('kyc-pending-section');
    const kycVerifiedSection = document.getElementById('kyc-verified-section');
    const kycDocumentUpload = document.getElementById('kyc-document-upload');
    const kycFileName = document.getElementById('kyc-file-name');
    const submitKycBtn = document.getElementById('submit-kyc-btn');
    const referralCountEl = document.getElementById('referral-count');
    const referralEarningsEl = document.getElementById('referral-earnings');
    const referralLinkInput = document.getElementById('referral-link-input');
    const copyReferralLinkBtn = document.getElementById('copy-referral-link-btn');
    const profileTabLinks = document.querySelectorAll('.profile-tab-link');
    const profileTabContents = document.querySelectorAll('.profile-tab-content > div');
    const chartTotalEl = document.getElementById('chart-total-earnings');
    const chartComparisonEl = document.getElementById('chart-comparison');
    const timespanBtns = document.querySelectorAll('.timespan-btn');
    
    let allPortsData = {}, currentUserData = {}, linkedAccountsData = [], paymentSettings = {}, kycFile = null;
    let earningsChart = null;
    
    async function callUpdateBalanceFunction(activityId) {
        try {
            const user = auth.currentUser;
            if (!user) throw new Error("User not authenticated.");
            
            const authToken = await user.getIdToken(true);
            const functionUrl = `/.netlify/functions/update-balance-on-demand`; 

            const response = await fetch(functionUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ authToken, activityId })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to update balance.');
            }
            
            console.log('Balance update triggered successfully.');
            fetchAllData(user);

        } catch (error) {
            console.error('Error calling update-balance function:', error);
            alert('Your transaction was recorded, but there was a delay updating your main balance. It will update shortly.');
        }
    }

    // --- 2. HELPER FUNCTIONS ---
    function formatTimestamp(d) { return new Intl.DateTimeFormat(undefined,{month:'short',day:'numeric',year:'numeric'}).format(d.toDate()); }
    function compressAndEncodeImage(file) { return new Promise((resolve, reject) => { const MAX_WIDTH = 800; const MAX_HEIGHT = 800; const JPEG_QUALITY = 0.8; const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (event) => { const img = new Image(); img.src = event.target.result; img.onload = () => { const canvas = document.createElement('canvas'); let width = img.width; let height = img.height; if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } } canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', JPEG_QUALITY)); }; img.onerror = reject; }; reader.onerror = reject; }); }
    function createActivityItem(d) {
        let i = document.createElement('li');
        i.className = 'activity-item';
        let c = 'fa-solid fa-question', b = '#e3e8f7', o = '#3b5bdb', a = '', p = '';
        let s = d.status ? `<span class="activity-status" style="color:#f39c12;font-weight:500;">${d.status}</span>` : formatTimestamp(d.timestamp);
        switch (d.type) {
            case 'earning': c = 'fa-solid fa-dollar-sign'; b = '#e0f5ea'; o = '#158a4a'; a = 'positive'; p = '+'; break;
            case 'withdrawal': c = 'fa-solid fa-arrow-right-to-bracket'; b = '#f7e3e3'; o = '#db3b3b'; a = 'negative'; p = '-'; break;
            case 'deposit': c = 'fa-solid fa-plus'; b = '#e0f0ff'; o = '#0055cc'; a = 'positive'; p = '+'; break;
            case 'investment': c = 'fa-solid fa-charging-station'; b = '#e3e8f7'; o = '#3b5bdb'; a = 'negative'; p = '-'; break;
            case 'maintenance': c = 'fa-solid fa-screwdriver-wrench'; b = '#eef0f3'; o = '#6c757d'; break;
        }
        let f = d.amount ? `${p}$${Math.abs(d.amount).toFixed(2)}` : (d.type === 'maintenance' ? '' : '$0.00');
        let desc = (d.description || '').replace('Deposit Request', 'Deposit').replace(' (Resolved)', '<span style="color:#158a4a;"> (Resolved)</span>').replace('Payment for', 'Package Payment:').split(' ').map(word => word.length > 30 ? `${word.substring(0, 9)}...${word.substring(word.length - 12)}` : word).join(' ');
        i.innerHTML = `<div class="activity-icon" style="background-color:${b};color:${o};"><i class="${c}"></i></div><div class="activity-details"><p>${desc}</p><span>${s}</span></div><p class="activity-amount ${a}">${f}</p>`;
        return i;
    }
    function createPortItem(id, d) { 
        let i=document.createElement('div');
        i.className='port-item';
        i.dataset.portId=id;
        let s=d.status||'Unknown',
            l=d.locationName||'Unnamed Port',
            p=d.portIdentifier||`#${id.substring(0,6)}`,
            m=parseFloat(d.monthlyEarnings)||0, 
            u=d.utilization||0,
            c=`status-${s.toLowerCase().replace(/ /g,'-')}`;
        i.innerHTML=`<div class="port-details"><h3 class="port-location">${l}</h3><p class="port-id">${p}</p></div><div class="port-info-grid"><div class="port-info-item"><span class="port-label">Status</span><span class="port-status ${c}">${s}</span></div><div class="port-info-item"><span class="port-label">Monthly Earnings</span><span class="port-value">$${m.toFixed(2)}</span></div><div class="port-info-item"><span class="port-label">Utilization</span><span class="port-value">${u}%</span></div></div>`;
        return i;
    }
    function createLinkedAccountItem(d) { let i=document.createElement('li');i.className='linked-account-item';i.dataset.accountId=d.id;i.innerHTML=`<i class="fa-solid fa-building-columns"></i><div class="account-details"><p>${d.bankName} - ${d.accountType} **** ${d.accountNumberLastFour}</p>${d.isPrimary?'<span>Primary Account</span>':''}</div>`;return i;}
    function generateRandomPortId() { const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'; const randomLetter = letters.charAt(Math.floor(Math.random() * letters.length)); const randomNumber = Math.floor(10 + Math.random() * 990); return `Port #${randomLetter}-${randomNumber}`; }
    
    // --- 3. DATA FETCHING ---
    function fetchAllData(user) { const uRef=db.collection('users').doc(user.uid);Promise.all([uRef.get(),uRef.collection('activity').orderBy('timestamp','desc').get(),uRef.collection('ports').orderBy('purchaseDate', 'desc').get(),uRef.collection('linkedAccounts').orderBy('isPrimary','desc').get(), db.collection('settings').doc('payment').get()]).then(([userDoc,actSnap,portSnap,accSnap, paymentSettingsDoc])=>{if(userDoc.exists){currentUserData=userDoc.data();userNameDesktop.textContent=currentUserData.firstName||'User';userNameMobile.textContent=currentUserData.firstName||'User';let bal=(currentUserData.availableBalance||0).toFixed(2);balanceAmountEl.textContent=bal;walletBalanceEl.textContent=bal;maxWithdrawBalanceEl.textContent=bal;balanceSubtitleEl.textContent=`$${(currentUserData.monthlyEarnings||0).toFixed(2)} earnings this month`;document.getElementById('profile-first-name').value=currentUserData.firstName||'';document.getElementById('profile-last-name').value=currentUserData.lastName||'';document.getElementById('profile-email').value=user.email;document.getElementById('profile-address').value=currentUserData.address?.street||'';document.getElementById('profile-city').value=currentUserData.address?.city||'';document.getElementById('profile-state').value=currentUserData.address?.state||'';document.getElementById('profile-zip').value=currentUserData.address?.zip||'';document.getElementById('profile-country').value=currentUserData.region||'';if(currentUserData.profilePictureUrl){profilePictureImg.src=currentUserData.profilePictureUrl;}kycUploadSection.classList.toggle('hidden',currentUserData.kycStatus==='Pending'||currentUserData.kycStatus==='Verified');kycPendingSection.classList.toggle('hidden',currentUserData.kycStatus!=='Pending');kycVerifiedSection.classList.toggle('hidden',currentUserData.kycStatus!=='Verified');referralCountEl.textContent=currentUserData.referralCount||0;referralEarningsEl.textContent=`$${(currentUserData.referralEarnings||0).toFixed(2)}`;referralLinkInput.value=`chargepace.com/register.html?ref=${user.uid}` } if (paymentSettingsDoc.exists) { paymentSettings = paymentSettingsDoc.data(); } else { console.log("Payment settings not found!"); } activityListEl.innerHTML='';let rAct=actSnap.docs.slice(0,5);if(rAct.length===0){activityListEl.innerHTML='<li style="padding:20px 0;text-align:center;color:var(--text-light);">No recent activity.</li>';}else{rAct.forEach(doc=>activityListEl.appendChild(createActivityItem(doc.data())));}walletTransactionListEl.innerHTML='';let fAct=actSnap.docs.filter(doc=>['earning','deposit','withdrawal', 'investment', 'maintenance'].includes(doc.data().type));if(fAct.length===0){walletTransactionListEl.innerHTML='<li style="padding:20px;text-align:center;color:var(--text-light);">No transactions found.</li>';}else{fAct.forEach(doc=>walletTransactionListEl.appendChild(createActivityItem(doc.data())));}portsListEl.innerHTML='';allPortsData={};if(portSnap.empty){portsListEl.innerHTML='<p style="text-align:center;color:var(--text-light);padding:20px;">You do not own any charging ports yet.</p>';}else{portSnap.forEach(doc=>{allPortsData[doc.id]=doc.data();portsListEl.appendChild(createPortItem(doc.id,doc.data()));});}linkedAccountsListEl.innerHTML='';linkedAccountsData=[];if(accSnap.empty){linkedAccountsListEl.innerHTML='<li style="padding:20px;text-align:center;color:var(--text-light);">No linked accounts.</li>';}else{accSnap.forEach(doc=>{let d={id:doc.id,...doc.data()};linkedAccountsData.push(d);linkedAccountsListEl.appendChild(createLinkedAccountItem(d));});} initializeChart(user); body.style.transition='opacity 0.5s';body.style.opacity='1';}).catch(err=>console.error("Error fetching all data:",err));}
    
    // --- 4. MODAL & FORM FUNCTIONS ---
    function openModal(el) { if (el) el.classList.remove('hidden'); }
    function closeModal(el) { if (el) el.classList.add('hidden'); }
    function openPortDetailsModal(portId) { 
        const portData = allPortsData[portId]; 
        if (!portData) { console.error("Port data not found for ID:", portId); return; } 
        document.getElementById('modal-port-location').textContent = portData.locationName || 'Unnamed Port'; 
        document.getElementById('modal-port-id').textContent = portData.portIdentifier || `#${portId.substring(0,6)}`; 
        const statusEl = document.getElementById('modal-port-status'); 
        statusEl.textContent = portData.status || 'Unknown'; 
        statusEl.className = 'port-status'; 
        const statusClass = `status-${(portData.status || 'unknown').toLowerCase().replace(/ /g, '-')}`; 
        statusEl.classList.add(statusClass); 
        document.getElementById('modal-activation-date').textContent = portData.activationDate ? formatTimestamp(portData.activationDate) : 'Pending'; 
        document.getElementById('modal-monthly-earnings').textContent = `$${(parseFloat(portData.monthlyEarnings) || 0).toFixed(2)}`; 
        document.getElementById('modal-lifetime-earnings').textContent = `$${(parseFloat(portData.lifetimeEarnings) || 0).toFixed(2)}`; 
        document.getElementById('modal-utilization').textContent = `${portData.utilization || 0}%`; 
         
        openModal(portModal); 
    }
    async function handleSubmitAddAccount(e) { e.preventDefault();const btn=addAccountForm.querySelector('button[type="submit"]');btn.disabled=true;btn.textContent='Saving...';try{const user=auth.currentUser;const ref=db.collection('users').doc(user.uid).collection('linkedAccounts');const data={bankName:addAccountForm['add-bank-name'].value.trim(),accountHolderName:addAccountForm['add-account-holder-name'].value.trim(),accountNumber:addAccountForm['add-account-number'].value.trim(),routingNumber:addAccountForm['add-routing-number'].value.trim(),accountType:addAccountForm['add-account-type'].value,isPrimary:setPrimaryAccountCheckbox.checked,accountNumberLastFour:addAccountForm['add-account-number'].value.trim().slice(-4)};if(data.isPrimary){const batch=db.batch();const q=await ref.where('isPrimary','==',true).get();q.forEach(doc=>batch.update(doc.ref,{isPrimary:false}));const newRef=ref.doc();batch.set(newRef,data);await batch.commit();}else{await ref.add(data);}alert('Bank account added successfully!');closeModal(addAccountModal);fetchAllData(user);}catch(err){console.error("Error adding bank account:",err);alert("An error occurred.");}finally{btn.disabled=false;btn.textContent='Add Account';}}
    function openViewAccountModal(id) { const acc=linkedAccountsData.find(a=>a.id===id);if(!acc)return;viewBankName.textContent=acc.bankName;viewAccountHolder.textContent=acc.accountHolderName;viewAccountNumber.textContent=acc.accountNumber;viewRoutingNumber.textContent=acc.routingNumber;viewAccountType.textContent=acc.accountType;viewIsPrimary.textContent=acc.isPrimary?'Yes':'No';deleteAccountBtn.dataset.accountId=id;openModal(viewAccountModal);}
    async function handleDeleteAccount(e) { const id=e.target.dataset.accountId;if(!id)return;if(confirm('Are you sure you want to delete this bank account?')){try{const user=auth.currentUser;await db.collection('users').doc(user.uid).collection('linkedAccounts').doc(id).delete();alert('Account deleted successfully.');closeModal(viewAccountModal);fetchAllData(user);}catch(err){console.error("Error deleting account:",err);alert("Could not delete the account.");}}}
    async function handleSubmitWithdrawal(e) {
        e.preventDefault();
        const btn = submitWithdrawalBtn;
        const amt = parseFloat(withdrawAmountInput.value);
        if (isNaN(amt) || amt <= 0) return alert("Please enter a valid amount.");
        if (amt > currentUserData.availableBalance) return alert("Amount exceeds available balance.");
        
        btn.disabled = true;
        btn.textContent = 'Submitting...';
        try {
            const user = auth.currentUser;
            const newActivityRef = await db.collection('users').doc(user.uid).collection('activity').add({
                type: 'withdrawal',
                status: 'Pending',
                amount: -amt,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            await callUpdateBalanceFunction(newActivityRef.id);
            alert('Withdrawal request submitted!');
            closeModal(withdrawModal);

        } catch (err) {
            console.error("Error submitting withdrawal:", err);
            alert("An error occurred while submitting your withdrawal request.");
        } finally {
            btn.disabled = false;
            btn.textContent = 'Submit Withdrawal';
        }
    }
    async function handleProfileUpdate(e) { e.preventDefault();const btn=e.target.querySelector('button[type="submit"]');btn.disabled=true;btn.textContent='Saving...';try{const user=auth.currentUser;const ref=db.collection('users').doc(user.uid);let picUrl = currentUserData.profilePictureUrl || null; const file = profilePictureUpload.files[0]; if (file) { try { picUrl = await compressAndEncodeImage(file); } catch (compressionError) { console.error("Error compressing image:", compressionError); alert("The selected image could not be processed."); btn.disabled = false; btn.textContent = 'Save Changes'; return; } } if (picUrl && picUrl.length > 1048487) { alert("The selected image is too large even after compression. Please choose a smaller file."); btn.disabled = false; btn.textContent = 'Save Changes'; return; } await ref.update({firstName:document.getElementById('profile-first-name').value,lastName:document.getElementById('profile-last-name').value,address:{street:document.getElementById('profile-address').value,city:document.getElementById('profile-city').value,state:document.getElementById('profile-state').value,zip:document.getElementById('profile-zip').value},profilePictureUrl:picUrl});alert('Profile updated!');fetchAllData(user);}catch(err){console.error("Error updating profile:",err);alert("An error occurred.");}finally{btn.disabled=false;btn.textContent='Save Changes';}}
    async function handleKycUpload() { if (!kycFile) return alert('Please choose a file.'); const btn = submitKycBtn; btn.disabled = true; btn.textContent = 'Uploading...'; try { const user = auth.currentUser; let docUrl; try { docUrl = await compressAndEncodeImage(kycFile); } catch (compressionError) { console.error("Error compressing KYC image:", compressionError); alert("The selected ID image could not be processed."); btn.disabled = false; btn.textContent = 'Upload for Verification'; return; } if (docUrl.length > 1048487) { alert("The ID image is too large even after compression. Please use a smaller file."); btn.disabled = false; btn.textContent = 'Upload for Verification'; return; } await db.collection('users').doc(user.uid).update({ kycDocumentUrl: docUrl, kycStatus: 'Pending' }); alert('KYC document submitted!'); fetchAllData(user); } catch (err) { console.error("Error submitting KYC:", err); alert("An error occurred while submitting your document."); } finally { btn.disabled = false; btn.textContent = 'Upload for Verification'; } }
    
    async function handlePaymentSubmission(paymentMethod) {
        const user = auth.currentUser;
        if (!user) return alert("You are not logged in.");
        
        const context = paymentModal.dataset.paymentContext;
        const amount = parseFloat(paymentAmountInput.value);
        if (isNaN(amount) || amount <= 0) return alert("Invalid amount.");

        const btn = (paymentMethod === 'crypto') ? proceedToPayCryptoBtn : proceedToPayCardBtn;
        btn.disabled = true;
        btn.textContent = 'Processing...';

        try {
            if (context === 'investment') {
                const { package, region } = investmentState;
                const activityDesc = `Payment for ${package}`;
                const activityRef = await db.collection('users').doc(user.uid).collection('activity').add({
                    type: 'investment',
                    status: 'Pending Approval',
                    description: activityDesc,
                    amount: -amount,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                });
                await db.collection('users').doc(user.uid).collection('ports').add({
                    package, region, status: 'Pending Approval', locationName: 'Pending Site Selection', 
                    purchaseDate: firebase.firestore.FieldValue.serverTimestamp()
                });
                goToInvestStep(4);
            } else if (context === 'deposit') {
                const activityRef = await db.collection('users').doc(user.uid).collection('activity').add({
                    type: 'deposit',
                    status: 'Pending',
                    description: `Deposit via ${paymentMethod}`,
                    amount: amount,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                await callUpdateBalanceFunction(activityRef.id);
                 alert('Your deposit has been recorded and your balance will be updated shortly.');
            }

            const paymentUrl = (paymentMethod === 'crypto') ? paymentSettings.nowpayments_link : paymentSettings.simplex_link;
            if (paymentUrl) {
                window.open(paymentUrl, 'paymentWindow', `width=500,height=700`);
            }
            closeModal(paymentModal);
            if (context !== 'investment') fetchAllData(user);

        } catch (err) {
            console.error(`Error processing ${context}:`, err);
            alert(`An error occurred during your ${context}. Please try again.`);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Proceed to Pay';
        }
    }
    
    let investmentState = {};
    function goToInvestStep(stepNumber) { investSteps.forEach(s => s.classList.add('hidden')); document.getElementById(`invest-step-${stepNumber}`)?.classList.remove('hidden'); }
    
    // --- 5. CHART LOGIC ---
    async function getEarningsDataForPeriod(user, days) { const now = new Date(); const currentPeriodEnd = new Date(now); const currentPeriodStart = new Date(new Date().setDate(now.getDate() - days)); const previousPeriodEnd = new Date(currentPeriodStart); previousPeriodEnd.setMilliseconds(previousPeriodEnd.getMilliseconds() - 1); const previousPeriodStart = new Date(new Date(previousPeriodEnd).setDate(previousPeriodEnd.getDate() - days)); const earningsRef = db.collection('users').doc(user.uid).collection('activity'); const currentPeriodQuery = earningsRef.where('type', '==', 'earning').where('timestamp', '>=', currentPeriodStart).where('timestamp', '<=', currentPeriodEnd).get(); const previousPeriodQuery = earningsRef.where('type', '==', 'earning').where('timestamp', '>=', previousPeriodStart).where('timestamp', '<', previousPeriodEnd).get(); const [currentSnap, previousSnap] = await Promise.all([currentPeriodQuery, previousPeriodQuery]); const processSnapshot = (snapshot, startDate, numDays) => { const dailyEarnings = Array(numDays + 1).fill(0); snapshot.forEach(doc => { const data = doc.data(); if (!data.timestamp || typeof data.amount !== 'number') return; const earningDate = data.timestamp.toDate(); const dayIndex = Math.floor((earningDate - startDate) / (1000 * 60 * 60 * 24)); if (dayIndex >= 0 && dayIndex <= numDays) { dailyEarnings[dayIndex] += data.amount; } }); const cumulativeEarnings = dailyEarnings.reduce((acc, val, index) => { acc.push((acc[index - 1] || 0) + val); return acc; }, []); return cumulativeEarnings; }; const currentData = processSnapshot(currentSnap, currentPeriodStart, days); const previousData = processSnapshot(previousSnap, previousPeriodStart, days); const todayIndex = currentData.length - 1; const previousValueAtSamePoint = previousData[todayIndex] || 0; const totalCurrent = currentData.length > 0 ? currentData[todayIndex] : 0; const comparison = totalCurrent - previousValueAtSamePoint; return { currentData, previousData, totalCurrent, comparison }; }
    function renderChart(chartData) {
        const options = {
            series: [{ name: 'Current', data: chartData.currentData }, { name: 'Previous', data: chartData.previousData }],
            chart: { height: 220, type: 'line', toolbar: { show: false }, zoom: { enabled: false }, sparkline: { enabled: true } },
            colors: ['#1e1e1e', '#e0e0e0'],
            stroke: { curve: 'smooth', width: 3 },
            grid: { show: true, borderColor: '#e0e0e0', strokeDashArray: 4, position: 'back', xaxis: { lines: { show: false } }, yaxis: { lines: { show: true } } },
            xaxis: { labels: { show: false }, axisBorder: { show: false }, axisTicks: { show: false }, tooltip: { enabled: false } },
            yaxis: { labels: { show: false } },
            tooltip: { enabled: true, x: { show: false }, custom: function({ series, seriesIndex, dataPointIndex, w }) { return ''; }, crosshairs: { show: true, stroke: { color: '#b6b6b6', width: 1, dashArray: 4, }, }, },
            legend: { show: false },
            noData: { text: 'No earnings data for this period.', align: 'center', verticalAlign: 'middle', style: { color: '#6c757d', fontSize: '14px', fontFamily: 'Inter' } }
        };
        if (earningsChart) { earningsChart.updateOptions(options); } else { earningsChart = new ApexCharts(document.querySelector("#earnings-chart"), options); earningsChart.render(); }
    }
    async function updateChart(user, range) { let days; switch(range) { case '6M': days = 180; break; case '1Y': days = 365; break; default: days = 30; } const chartData = await getEarningsDataForPeriod(user, days); renderChart(chartData); }
    async function initializeChart(user) { if(!user) return; timespanBtns.forEach(btn => { btn.addEventListener('click', () => { timespanBtns.forEach(b => b.classList.remove('active')); btn.classList.add('active'); updateChart(user, btn.dataset.range); }); }); await updateChart(user, '30D'); }
    
    // --- 6. EVENT LISTENERS ---
    function handleNavigation(e) { e.preventDefault();const targetId=e.currentTarget.dataset.target;if(!targetId)return;pageContents.forEach(c=>c.classList.add('hidden'));document.getElementById(targetId)?.classList.remove('hidden');navLinks.forEach(n=>n.classList.remove('active'));document.querySelectorAll(`[data-target="${targetId}"]`).forEach(l=>l.classList.add('active'));}
    function handleProfileTabNavigation(e) { const id=e.currentTarget.dataset.target;profileTabLinks.forEach(l=>l.classList.remove('active'));e.currentTarget.classList.add('active');profileTabContents.forEach(c=>c.classList.toggle('hidden',c.id!==id));}
    const handleLogout = () => auth.signOut().then(() => { window.location.href = 'login.html'; });
    auth.onAuthStateChanged(user => { if (user && user.emailVerified) { fetchAllData(user); } else { window.location.replace('login.html'); } });
    navLinks.forEach(link => link.addEventListener('click', handleNavigation));
    selectPackageBtns.forEach(btn => btn.addEventListener('click', (e) => { investmentState.package = e.currentTarget.dataset.package; investmentState.price = parseFloat(e.currentTarget.dataset.price); goToInvestStep(2); }));
    investNavBtns.forEach(btn => btn.addEventListener('click', (e) => { const button = e.currentTarget; const targetStep = button.dataset.targetStep; const targetPage = button.dataset.targetPage; if (targetStep === '3') { const regionSelect = document.getElementById('region-select'); if (!regionSelect.value) { return alert('Please select an investment region.'); } investmentState.region = regionSelect.value; document.getElementById('summary-package-name').textContent = investmentState.package; document.getElementById('summary-region').textContent = investmentState.region; const fee = 499.00; const hardwareCost = investmentState.price - fee; document.getElementById('summary-hardware-cost').textContent = `$${hardwareCost.toFixed(2)}`; document.getElementById('summary-fee-cost').textContent = `$${fee.toFixed(2)}`; document.getElementById('summary-total-cost').textContent = `$${investmentState.price.toFixed(2)}`; } if (targetStep) { goToInvestStep(targetStep); } if (targetPage) { const navElement = document.querySelector(`.nav-link[data-target="${targetPage}"], .sidebar-link[data-target="${targetPage}"]`); if(navElement) navElement.click(); } }));
    
    if (confirmAndPayBtn) {
        confirmAndPayBtn.addEventListener('click', () => {
            if (!termsCheckbox.checked) {
                return alert('You must agree to the Investment Terms & Conditions to proceed.');
            }
            paymentModal.dataset.paymentContext = 'investment';
            paymentModalTitle.textContent = 'Make a Payment';
            paymentAmountInput.value = investmentState.price;
            paymentAmountInput.readOnly = true;
            openModal(paymentModal);
        });
    }

    depositButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            paymentModal.dataset.paymentContext = 'deposit';
            paymentModalTitle.textContent = 'Make a Deposit';
            paymentAmountInput.value = '';
            paymentAmountInput.readOnly = false;
            paymentAmountInput.placeholder = 'Enter amount (e.g., 500)';
            openModal(paymentModal);
        });
    });

    if (addAccountBtn) { addAccountBtn.addEventListener('click', () => { addAccountForm.reset(); openModal(addAccountModal); }); }
    if (addAccountForm) { addAccountForm.addEventListener('submit', handleSubmitAddAccount); }
    if (linkedAccountsListEl) { linkedAccountsListEl.addEventListener('click', e => { const item = e.target.closest('.linked-account-item'); if (item) { openViewAccountModal(item.dataset.accountId); } }); }
    if (deleteAccountBtn) { deleteAccountBtn.addEventListener('click', handleDeleteAccount); }
    if (payWithCryptoBtn) { payWithCryptoBtn.addEventListener('click', () => { cryptoPaymentSection.classList.remove('hidden'); cardPaymentSection.classList.add('hidden'); paymentModal.dataset.paymentMethod = 'crypto'; }); }
    if (payWithCardBtn) { payWithCardBtn.addEventListener('click', () => { cardPaymentSection.classList.remove('hidden'); cryptoPaymentSection.classList.add('hidden'); paymentModal.dataset.paymentMethod = 'card'; if(paymentSettings.btc_address) { btcAddressDisplay.value = paymentSettings.btc_address; } else { btcAddressDisplay.value = "Could not load address."; } }); }
    if (portsListEl) { portsListEl.addEventListener('click', e => { const item = e.target.closest('.port-item'); if (item && item.dataset.portId) { openPortDetailsModal(item.dataset.portId); } }); }
    if (proceedToPayCryptoBtn) { proceedToPayCryptoBtn.addEventListener('click', () => handlePaymentSubmission('crypto')); }
    if (proceedToPayCardBtn) { proceedToPayCardBtn.addEventListener('click', () => handlePaymentSubmission('card')); }
    if (walletWithdrawBtn) { walletWithdrawBtn.addEventListener('click', () => openModal(withdrawModal)); }
    
    if (withdrawMethodSelect) {
        withdrawMethodSelect.addEventListener('change', () => {
            const selectedMethod = withdrawMethodSelect.value;
            bankWithdrawalSection.classList.toggle('hidden', selectedMethod !== 'bank');
            cryptoWithdrawalSection.classList.toggle('hidden', selectedMethod !== 'crypto');
        });
    }

    if (submitWithdrawalBtn) { submitWithdrawalBtn.addEventListener('click', handleSubmitWithdrawal); }
    if (profileForm) { profileForm.addEventListener('submit', handleProfileUpdate); }
    if (profilePictureUpload) { profilePictureUpload.addEventListener('change', e => { const f = e.target.files[0]; if (f) { const r = new FileReader(); r.onload = ev => profilePictureImg.src = ev.target.result; r.readAsDataURL(f); } }); }
    if (kycDocumentUpload) { kycDocumentUpload.addEventListener('change', e => { kycFile = e.target.files[0]; if (kycFile) kycFileName.textContent = kycFile.name; }); }
    if (submitKycBtn) { submitKycBtn.addEventListener('click', handleKycUpload); }
    if (copyReferralLinkBtn) { copyReferralLinkBtn.addEventListener('click', () => { referralLinkInput.select(); document.execCommand('copy'); copyReferralLinkBtn.textContent = 'Copied!'; setTimeout(() => { copyReferralLinkBtn.textContent = 'Copy'; }, 2000); }); }
    if (profileTabLinks) { profileTabLinks.forEach(link => link.addEventListener('click', handleProfileTabNavigation)); }
    allModalCloseButtons.forEach(btn => { btn.addEventListener('click', (e) => { const modal = e.target.closest('.modal-overlay'); closeModal(modal); }); });
    allModalOverlays.forEach(overlay => { overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(overlay); }); });
    if (logoutButtonDesktop) logoutButtonDesktop.addEventListener('click', handleLogout);
    if (logoutButtonMobile) logoutButtonMobile.addEventListener('click', handleLogout);
});
</script>

</body>
</html>