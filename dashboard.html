<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ChargePace</title>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Local CSS -->
    <link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body class="dashboard-page">

    <!-- Left Sidebar for Desktop View -->
    <nav class="sidebar-nav">
        <a href="#" data-target="home-content" class="sidebar-logo">CHARGEPACE</a>
        <div class="sidebar-links">
            <a href="#" data-target="home-content" class="sidebar-link active"><i class="fa-solid fa-house"></i><span>Dashboard</span></a>
            <a href="#" data-target="my-ports-content" class="sidebar-link"><i class="fa-solid fa-charging-station"></i><span>My Ports</span></a>
            <a href="#" data-target="wallet-content" class="sidebar-link"><i class="fa-solid fa-wallet"></i><span>Wallet</span></a>
            <a href="#" data-target="invest-content" class="sidebar-link"><i class="fa-solid fa-chart-pie"></i><span>Invest</span></a>
            <a href="#" data-target="profile-content" class="sidebar-link"><i class="fa-solid fa-user"></i><span>Profile</span></a>
        </div>
        <div class="sidebar-logout"><button id="logout-button-desktop"><i class="fa-solid fa-arrow-right-from-bracket"></i><span>Log Out</span></button></div>
    </nav>

        <!-- Main Content Area -->
    <div class="main-content">
        <div class="page-content-container">
                         <!-- ========= HOME / DASHBOARD CONTENT ========= -->
            <div id="home-content" class="page-content active">
                <header class="mobile-header"><div class="user-info"><p>Welcome Back,</p><h1 id="user-name-mobile">Loading...</h1></div><button id="logout-button-mobile" class="logout-icon"><i class="fa-solid fa-arrow-right-from-bracket"></i></button></header>
                <header class="desktop-header"><h1>Dashboard</h1><div class="user-info"><span>Welcome, <span id="user-name-desktop">Loading...</span></span></div></header>
                <main class="dashboard-grid"><section class="card balance-card">
    <div class="balance-header">
        <p>Available Balance</p> <!-- Text changed here -->
    </div>
    <div class="balance-amount">
        <span>$</span><p>0.00</p>
    </div>
    <div class="balance-subtitle">
        <i class="fa-solid fa-arrow-trend-up"></i>
        <p>$0.00 earnings this month</p>
    </div>
    <div class="balance-actions">
        <button class="btn btn-primary"><i class="fa-solid fa-arrow-down"></i> Withdraw</button>
        <button class="btn btn-secondary deposit-btn"><i class="fa-solid fa-plus"></i> Deposit</button>
    </div>
</section>
<section class="kpi-grid-container">
    <div class="kpi-card">
        <div class="kpi-icon"><i class="fa-solid fa-charging-station"></i></div>
        <div class="kpi-value" id="kpi-active-ports">0</div>
        <p class="kpi-label">Active Ports</p>
    </div>
    <div class="kpi-card">
        <div class="kpi-icon"><i class="fa-solid fa-bolt"></i></div>
        <div class="kpi-value"><span id="kpi-kwh-delivered">0.0</span> <span class="kpi-unit">kWh</span></div>
        <p class="kpi-label">Energy Delivered</p>
    </div>
    <div class="kpi-card">
        <div class="kpi-icon"><i class="fa-solid fa-car"></i></div>
        <div class="kpi-value" id="kpi-charging-sessions">0</div>
        <p class="kpi-label">Charging Sessions</p>
    </div>
    <div class="kpi-card">
        <div class="kpi-icon"><i class="fa-solid fa-leaf"></i></div>
        <div class="kpi-value"><span id="kpi-co2-offset">0.0</span> <span class="kpi-unit">kg</span></div>
        <p class="kpi-label">COâ‚‚ Offset (Est.)</p>
    </div>
</section>
<section class="card activity-card"><h3>Recent Activity</h3><ul class="activity-list"><li style="padding: 20px 0; text-align: center; color: var(--text-light);">Loading activity...</li></ul></section></main>
            </div>

            <!-- ========= MY PORTS CONTENT ========= -->
            <div id="my-ports-content" class="page-content hidden">
                <header class="mobile-header"><div class="user-info"><h1>My Charging Ports</h1></div></header>
                <header class="desktop-header"><h1>My Charging Ports</h1></header>
                <main><div class="ports-list"></div></main>
            </div>

            <!-- ========= INVEST CONTENT ========= -->
            <div id="invest-content" class="page-content hidden">
                <header class="mobile-header"><div class="user-info"><h1>Invest</h1></div></header>
                <header class="desktop-header"><h1>Invest in a New Port</h1></header>
                <main class="invest-wizard-container">
                    <!-- STEP 1: CHOOSE PACKAGE (No Changes) -->
                    <div id="invest-step-1" class="invest-step active">
                        <div class="step-header"><h2>Step 1: Choose Your Investment Package</h2></div>
                        <div class="package-selection-grid">
                            <div class="package-card">
                                <img src="images/standard-charger.png" alt="Standard EV Charger" class="package-image">
                                <div class="package-details">
                                    <h3>Standard Port</h3>
                                    <p class="package-price">$1,299</p>
                                    <ul class="package-features">
                                        <li><i class="fa-solid fa-check"></i> Expert Site Selection Included</li>
                                        <li><i class="fa-solid fa-check"></i> Ideal for Steady Returns</li>
                                        <li><i class="fa-solid fa-check"></i> Fully Managed by ChargePace</li>
                                    </ul>
                                    <button class="btn btn-primary select-package-btn" data-package="Standard Port" data-price="1299">Select Package</button>
                                </div>
                            </div>
                            <div class="package-card">
                                <img src="images/pro-charger.png" alt="Pro EV Charger" class="package-image">
                                <div class="package-details">
                                    <h3>High-Traffic Pro Port</h3>
                                    <p class="package-price">$2,499</p>
                                    <ul class="package-features">
                                        <li><i class="fa-solid fa-check"></i> Prime High-Traffic Site Selection</li>
                                        <li><i class="fa-solid fa-check"></i> Maximized Earnings Potential</li>
                                        <li><i class="fa-solid fa-check"></i> Fully Managed by ChargePace</li>
                                    </ul>
                                    <button class="btn btn-primary select-package-btn" data-package="High-Traffic Pro Port" data-price="2499">Select Package</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 2: APPLICATION FORM (Replaces old Step 2) -->
                    <div id="invest-step-2" class="invest-step hidden">
                        <div class="step-header"><h2>Step 2: Complete Your Application</h2><p class="step-subtitle">Please provide your details. This information will be used to generate your investment contract.</p></div>
                        <div class="card">
                            <div class="application-form-grid">
                                <div class="form-group"><label for="apply-legal-name">Full Legal Name</label><input type="text" id="apply-legal-name" placeholder="As it appears on your ID"></div>
                                <div class="form-group"><label for="apply-phone-number">Contact Phone Number</label><input type="tel" id="apply-phone-number" placeholder="(555) 123-4567"></div>
                                <div class="form-group full-width"><label for="apply-address">Full Mailing Address</label><input type="text" id="apply-address" placeholder="Street, City, State, Zip, Country"></div>
                                <div class="form-group"><label for="region-select">Investment Region (Country)</label><select id="region-select"><option value="">Please select a country...</option><optgroup label="North America"><option value="United States">United States</option><option value="Canada">Canada</option><option value="Mexico">Mexico</option><option value="Puerto Rico">Puerto Rico</option></optgroup><optgroup label="Europe"><option value="Austria">Austria</option><option value="Belgium">Belgium</option><option value="Denmark">Denmark</option><option value="Finland">Finland</option><option value="France">France</option><option value="Germany">Germany</option><option value="Hungary">Hungary</option><option value="Iceland">Iceland</option><option value="Italy">Italy</option><option value="Spain">Spain</option><option value="Sweden">Sweden</option><option value="United Kingdom">United Kingdom</option></optgroup><optgroup label="Asia"><option value="China">China</option><option value="Japan">Japan</option><option value="Hong Kong">Hong Kong</option><option value="Israel">Israel</option><option value="Jordan">Jordan</option><option value="Qatar">Qatar</option><option value="United Arab Emirates">United Arab Emirates</option></optgroup><optgroup label="Oceania"><option value="Australia">Australia</option><option value="New Zealand">New Zealand</option></optgroup><optgroup label="Africa"><option value="Morocco">Morocco</option></optgroup></select></div>
                                <div class="form-group"><label for="apply-source">How did you hear about us?</label><select id="apply-source"><option value="">Please select an option...</option><option value="Referral">Friend / Referral</option><option value="Online Search">Online Search</option><option value="Social Media">Social Media</option><option value="Advertisement">Advertisement</option><option value="Other">Other</option></select></div>
                            </div>
                            <div class="form-navigation"><button class="btn btn-secondary invest-nav-btn" data-target-step="1">Back</button><button class="btn btn-primary invest-nav-btn" data-target-step="3">Review Application</button></div>
                        </div>
                    </div>

                    <!-- STEP 3: REVIEW AND CONFIRM (Replaces old Step 3) -->
                    <div id="invest-step-3" class="invest-step hidden">
                        <div class="step-header"><h2>Step 3: Review and Confirm</h2></div>
                        <div class="card">
                            <h3>Application Summary</h3>
                            <div class="summary-details">
                                <div class="summary-item"><span>Package</span><strong id="summary-package-name">Loading...</strong></div>
                                <div class="summary-item"><span>Total Investment</span><strong id="summary-total-cost">$0.00</strong></div>
                                <div class="summary-item"><span>Investment Region</span><strong id="summary-region">Loading...</strong></div>
                                <div class="summary-item"><span>Full Legal Name</span><strong id="summary-legal-name">Loading...</strong></div>
                                <div class="summary-item"><span>Contact Phone</span><strong id="summary-phone">Loading...</strong></div>
                                <div class="summary-item"><span>Mailing Address</span><strong id="summary-address">Loading...</strong></div>
                            </div>
                            <div class="what-happens-next">
                                <h4>What Happens Next?</h4>
                                <p>After submitting, our team will review your application. If approved, you will receive an email within 24-48 hours containing your formal investment contract and detailed payment instructions. You can track your application status on the 'My Ports' page.</p>
                            </div>
                            <div class="terms-agreement">
                                <input type="checkbox" id="terms-checkbox">
                                <label for="terms-checkbox">I have read and agree to the <a href="terms.html" target="_blank">Investment Terms & Conditions</a>.</label>
                            </div>
                            <div class="form-navigation">
                                <button class="btn btn-secondary invest-nav-btn" data-target-step="2">Back</button>
                                <button id="submit-application-btn" class="btn btn-primary">Submit Application</button>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 4: CONFIRMATION (Replaces old Step 4) -->
                    <div id="invest-step-4" class="invest-step hidden">
                        <div class="card success-message-card">
                            <div class="step-title-wrapper">
                                <i class="fa-solid fa-paper-plane success-icon" style="color: #158a4a;"></i>
                                <h2>Application Submitted</h2>
                            </div>
                            <p>Thank you! Your investment application has been received. You can monitor its status in the 'My Ports' section. Our team will review your submission and contact you via email with the next steps.</p>
                            <button class="btn btn-primary invest-nav-btn" data-target-page="my-ports-content" style="margin-top: 1.5rem;">View My Ports</button>
                        </div>
                    </div>
                </main>
            </div>

            <!-- ========= WALLET CONTENT ========= -->
            <div id="wallet-content" class="page-content hidden">
                <header class="mobile-header"><div class="user-info"><h1>Wallet</h1></div></header>
                <header class="desktop-header"><h1>Wallet</h1></header>
                <main>
                    <!-- MODIFICATION: Wrapper for the new top grid layout on desktop -->
                    <div class="wallet-layout-top">
                        <div class="card wallet-summary-card">
                            <div class="wallet-balance-info">
                                <span class="port-label">Available Balance</span>
                                <div class="balance-amount">
                                    <span>$</span><p id="wallet-balance">0.00</p>
                                </div>
                            </div>
                            <div class="wallet-actions">
                                <button id="wallet-withdraw-btn" class="btn btn-secondary"><i class="fa-solid fa-arrow-down"></i> Withdraw</button>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Linked Accounts</h3>
                                <button id="add-account-btn" class="btn btn-sm btn-outline">Add Account</button>
                            </div>
                            <div class="card-content">
                                <ul id="linked-accounts-list" class="linked-accounts-list"></ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Transaction History</h3>
                        </div>
                        <div class="card-content" style="padding: 0;">
                            <ul id="wallet-transaction-list" class="activity-list"></ul>
                        </div>
                    </div>
                </main>
            </div>
            
            <!-- ========= PROFILE & REFERRALS CONTENT ========= -->
            <div id="profile-content" class="page-content hidden">
                <header class="mobile-header"><div class="user-info"><h1>Profile</h1></div></header>
                <header class="desktop-header"><h1>Profile</h1></header>
                <main>
                    <div class="profile-tabs">
    <button class="profile-tab-link active" data-target="profile-settings-content">Settings</button>
    <button class="profile-tab-link" data-target="profile-referrals-content">Referrals</button>
    <button class="profile-tab-link" data-target="profile-support-content">Support</button>
</div>

                    <div class="profile-tab-content">
                        <div id="profile-settings-content">
                            <!-- MODIFICATION: Wrapper for profile cards to control spacing -->
                            <div class="profile-cards-wrapper">
                                <div class="card">
                                    <form id="profile-form">
                                        <div class="profile-picture-container">
                                            <div class="profile-picture-wrapper"><img src="https://i.stack.imgur.com/34AD2.jpg" alt="Profile Picture" class="profile-picture" id="profile-picture-img"><label for="profile-picture-upload" class="profile-picture-upload-btn"><i class="fa-solid fa-camera"></i></label><input type="file" id="profile-picture-upload" accept="image/*" style="display: none;"></div>
                                        </div>
                                        <h2>Personal Information</h2>
                                        <div class="profile-grid">
                                            <div class="form-group"><label for="profile-first-name">First Name</label><input type="text" id="profile-first-name"></div>
                                            <div class="form-group"><label for="profile-last-name">Last Name</label><input type="text" id="profile-last-name"></div>
                                        </div>
                                        <div class="form-group"><label for="profile-email">Email Address</label><input type="email" id="profile-email" readonly></div>
                                        <h2 style="margin-top: 2rem;">Address Information</h2>
                                        <div class="form-group"><label for="profile-address">Street Address</label><input type="text" id="profile-address"></div>
                                        <div class="profile-grid">
                                            <div class="form-group"><label for="profile-city">City</label><input type="text" id="profile-city"></div>
                                            <div class="form-group"><label for="profile-state">State / Province</label><input type="text" id="profile-state"></div>
                                            <div class="form-group"><label for="profile-zip">ZIP / Postal Code</label><input type="text" id="profile-zip"></div>
                                            <div class="form-group"><label for="profile-country">Country</label><input type="text" id="profile-country" readonly></div>
                                        </div>
                                        <div class="modal-actions" style="border-top: none; padding-top: 0;"><button type="submit" class="btn btn-primary">Save Changes</button></div>
                                    </form>
                                </div>
                                <div class="card">
                                    <h2>KYC Verification</h2>
                                    <div id="kyc-verified-section" class="hidden" style="text-align: center; padding: 1rem;"><p style="font-weight: 500;">Your ID has been verified.</p><span class="kyc-status-badge verified">Verified</span></div>
                                    <div id="kyc-pending-section" class="hidden" style="text-align: center; padding: 1rem;"><p style="font-weight: 500;">Your ID is currently under review.</p><span class="kyc-status-badge pending">Pending</span></div>
                                    <div id="kyc-upload-section"><p>Please upload a clear image of a government-issued ID (e.g., Driver's License, Passport).</p><div class="kyc-upload-area"><i class="fa-solid fa-id-card"></i><label for="kyc-document-upload" class="btn btn-secondary">Choose File</label><input type="file" id="kyc-document-upload" accept="image/*" style="display: none;"><p id="kyc-file-name" style="margin-top: 1rem;"></p></div><div class="modal-actions" style="border-top: none; padding-top: 1rem;"><button id="submit-kyc-btn" class="btn btn-primary">Upload for Verification</button></div></div>
                                </div>
                            </div>
                        </div>
                        <div id="profile-referrals-content" class="hidden">
                           <!-- Referrals content remains the same -->
                           <div class="referral-stats-grid"><div class="stat-card"><p id="referral-count" class="stat-value">0</p><p class="stat-label">Total Referrals</p></div><div class="stat-card"><p id="referral-earnings" class="stat-value">$0.00</p><p class="stat-label">Total Earnings</p></div></div><div class="card"><h2>Your Referral Link</h2><p>Share your referral link with friends and earn 10% of their profits!</p><div class="referral-link-container"><input type="text" id="referral-link-input" readonly><button id="copy-referral-link-btn" class="btn btn-primary">Copy</button></div></div>
                        </div>
                        <div id="profile-support-content" class="hidden">
                           <div class="profile-cards-wrapper">
                               <div class="card">
                                   <h2>Live Chat Support</h2>
                                   <p class="step-subtitle">Have a question? Send a message to our support team directly.</p>
                                   <div class="chat-window" id="chat-window"></div>
                                   <form id="support-chat-form" class="chat-input-form">
                                       <input type="text" id="chat-message-input" placeholder="Type your message..." required>
                                       <button type="submit" class="btn btn-primary"><i class="fa-solid fa-paper-plane"></i></button>
                                   </form>
                                   <button id="new-conversation-btn" class="btn btn-secondary hidden" style="width: 100%; margin-top: 15px;">
                                       <i class="fa-solid fa-plus"></i> Start New Conversation
                                   </button>
                               </div>
                               <div class="card">
                                   <h2>Contact Email</h2>
                                   <p>For less urgent inquiries, you can reach us via email at <a href="mailto:support@chargepace.com">support@chargepace.com</a>.</p>
                               </div>
                           </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- ALL MODALS -->
    <div id="port-details-modal" class="modal-overlay hidden"><div class="modal-content"><div class="modal-header"><div><h2 id="modal-port-location">Port Location Name</h2><p id="modal-port-id" class="port-id">#PORT-ID</p></div><button class="modal-close-button">&times;</button></div><div class="modal-info-grid"><div class="port-info-item"><span class="port-label">Status</span><span id="modal-port-status" class="port-status">Loading...</span></div><div class="port-info-item"><span class="port-label">Activation Date</span><span id="modal-activation-date" class="port-value">Loading...</span></div><div class="port-info-item"><span class="port-label">Monthly Earnings</span><span id="modal-monthly-earnings" class="port-value">Loading...</span></div><div class="port-info-item"><span class="port-label">Lifetime Earnings</span><span id="modal-lifetime-earnings" class="port-value">Loading...</span></div><div class="port-info-item"><span class="port-label">Utilization</span><span id="modal-utilization" class="port-value">Loading...</span></div></div></div></div>
    
    <div id="payment-modal" class="modal-overlay hidden" data-payment-context="deposit" data-payment-method="">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="payment-modal-title">Make a Deposit</h2>
                <button class="modal-close-button">&times;</button>
            </div>
            <div class="form-group">
                <label for="payment-amount">Amount (USD)</label>
                <input type="number" id="payment-amount" placeholder="Enter amount (e.g., 500)">
            </div>
            <div class="payment-options">
                <button id="pay-with-crypto" class="btn btn-secondary"><i class="fa-brands fa-bitcoin"></i>&nbsp; Pay With Crypto</button>
                <button id="pay-with-card" class="btn btn-secondary"><i class="fa-solid fa-credit-card"></i>&nbsp; Pay With Card</button>
            </div>
            <div id="crypto-payment-section" class="payment-section hidden">
                <p class="payment-instruction">You will be redirected to our secure partner NowPayments to complete your transaction.</p>
                <button id="proceed-to-pay-crypto" class="btn btn-primary">Proceed to Pay</button>
            </div>
            <!-- ================== HTML CHANGE IS HERE ================== -->
            <div id="card-payment-section" class="payment-section hidden">
                <p class="payment-instruction">You will be redirected to Stripe to complete your payment. Once finished, please return to this tab.</p>
                <button id="proceed-to-pay-card" class="btn btn-primary">Proceed to Pay</button>
            </div>
            <!-- ================== END OF HTML CHANGE ================== -->
        </div>
    </div>

    <div id="add-account-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Bank Account</h2>
                <button class="modal-close-button">&times;</button>
            </div>
            <!-- === WRAPPER ADDED HERE === -->
            <div class="modal-body">
                <form id="add-account-form">
                    <div class="form-group">
                        <label for="add-bank-name">Bank Name</label>
                        <input type="text" id="add-bank-name" placeholder="e.g., Chase Bank" required>
                    </div>
                    <div class="form-group">
                        <label for="add-account-holder-name">Account Holder Name</label>
                        <input type="text" id="add-account-holder-name" placeholder="e.g., John Doe" required>
                    </div>
                    <div class="form-group">
                        <label for="add-account-number">Account Number</label>
                        <input type="text" id="add-account-number" placeholder="Enter full account number" required>
                    </div>
                    <div class="form-group">
                        <label for="add-routing-number">Routing Number</label>
                        <input type="text" id="add-routing-number" placeholder="Enter routing number" required>
                    </div>
                    <div class="form-group">
                        <label for="add-account-type">Account Type</label>
                        <select id="add-account-type" required>
                            <option value="Checking">Checking</option>
                            <option value="Savings">Savings</option>
                        </select>
                    </div>
                    <div class="toggle-switch-container">
                        <label for="set-primary-account-toggle">Set as primary account</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="set-primary-account-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="modal-actions">
                        <button type="submit" id="submit-add-account" class="btn btn-primary">Add Account</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="view-account-modal" class="modal-overlay hidden"><div class="modal-content"><div class="modal-header"><h2>Account Details</h2><button class="modal-close-button">&times;</button></div><div class="view-account-details"><div class="detail-item"><span class="detail-label">Bank Name</span><span id="view-bank-name" class="detail-value"></span></div><div class="detail-item"><span class="detail-label">Account Holder</span><span id="view-account-holder" class="detail-value"></span></div><div class="detail-item"><span class="detail-label">Account Number</span><span id="view-account-number" class="detail-value"></span></div><div class="detail-item"><span class="detail-label">Routing Number</span><span id="view-routing-number" class="detail-value"></span></div><div class="detail-item"><span class="detail-label">Account Type</span><span id="view-account-type" class="detail-value"></span></div><div class="detail-item"><span class="detail-label">Primary</span><span id="view-is-primary" class="detail-value"></span></div></div><div class="modal-actions"><button id="delete-account-btn" class="btn btn-danger"><i class="fa-solid fa-trash"></i> Delete Account</button></div></div></div>
    
    <div id="withdraw-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Withdraw Funds</h2>
                <button class="modal-close-button">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="withdraw-amount">Amount</label>
                    <div class="amount-input-group" style="position: relative;">
    <input type="number" id="withdraw-amount" placeholder="0.00" style="padding-right: 60px;">
    <!-- NEW MAX BUTTON -->
    <button id="btn-max-amount" type="button" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--primary-color); font-weight: 600; cursor: pointer; font-size: 0.9rem;">MAX</button>
</div>
                        <div class="balance-display">Available: $<span id="max-withdraw-balance">0.00</span></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="withdraw-method">Withdrawal Method</label>
                    <select id="withdraw-method">
                        <option value="">Select withdrawal method</option>
                        <option value="crypto">Crypto Withdrawal</option>
                        <option value="bank">Bank Transfer</option>
                    </select>
                </div>
                <div id="crypto-withdrawal-section" class="withdrawal-section hidden">
                    <div class="form-group">
                        <label for="crypto-currency">Select Cryptocurrency</label>
                        <select id="crypto-currency">
                            <option value="BTC">Bitcoin (BTC)</option>
                            <option value="USDT">Tether (USDT)</option>
                            <option value="ETH">Ethereum (ETH)</option>
                            <option value="LTC">Litecoin (LTC)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="crypto-address">Wallet Address</label>
                        <input type="text" id="crypto-address" placeholder="Enter your wallet address">
                    </div>
                </div>
                <!-- === MODIFIED SECTION START === -->
                <div id="bank-withdrawal-section" class="withdrawal-section hidden">
                    <div class="form-group">
                        <label for="linked-account-select">Select Linked Account</label>
                        <select id="linked-account-select">
                            <!-- This will be populated by JavaScript -->
                        </select>
                         <p class="input-hint">Don't see your account? You can add one from the Wallet page.</p>
                    </div>
                </div>
                <!-- === MODIFIED SECTION END === -->
                <div class="form-group">
                    <label for="withdrawal-code">Withdrawal Code</label>
                    <input type="text" id="withdrawal-code" placeholder="Enter 6-digit withdrawal code" maxlength="6">
                    <p class="input-hint">Contact support if you don't have a withdrawal code.</p>
                </div>
            </div> 
            <div class="modal-actions">
                <button id="submit-withdrawal" class="btn btn-primary">Withdraw</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation for Mobile View -->
    <nav class="bottom-nav">
        <a href="#" data-target="home-content" class="nav-link active"><i class="fa-solid fa-house"></i><span>Home</span></a>
        <a href="#" data-target="my-ports-content" class="nav-link"><i class="fa-solid fa-charging-station"></i><span>My Ports</span></a>
        <a href="#" data-target="invest-content" class="nav-link nav-link-primary"><i class="fa-solid fa-plus"></i></a>
        <a href="#" data-target="wallet-content" class="nav-link"><i class="fa-solid fa-wallet"></i><span>Wallet</span></a>
        <a href="#" data-target="profile-content" class="nav-link"><i class="fa-solid fa-user"></i><span>Profile</span></a>
    </nav>

    <div id="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- Firebase and Auth Logic -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
      const firebaseConfig = { apiKey: "AIzaSyDxAuX5hEWOuYdeGSvQHxhMlb9hyRZTNYw", authDomain: "twc2-95e6e.firebaseapp.com", projectId: "twc2-95e6e", storageBucket: "twc2-95e6e.appspot.com", messagingSenderId: "648663487938", appId: "1:648663487938:web:f466fd8fdd893bdaeef25b" };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
    </script>
    
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 1. ELEMENT SELECTORS ---
    const body = document.querySelector('body');
    const userNameDesktop = document.getElementById('user-name-desktop');
    const userNameMobile = document.getElementById('user-name-mobile');
    const logoutButtonDesktop = document.getElementById('logout-button-desktop');
    const logoutButtonMobile = document.getElementById('logout-button-mobile');
    const balanceAmountEl = document.querySelector('#home-content .balance-amount p');
    const balanceSubtitleEl = document.querySelector('.balance-subtitle p');
    const depositButtons = document.querySelectorAll('.deposit-btn');
    const activityListEl = document.querySelector('#home-content .activity-list');
    const portsListEl = document.querySelector('.ports-list');
    const navLinks = document.querySelectorAll('.nav-link, .sidebar-link');
    const pageContents = document.querySelectorAll('.page-content');
    const walletBalanceEl = document.getElementById('wallet-balance');
    const linkedAccountsListEl = document.getElementById('linked-accounts-list');
    const walletTransactionListEl = document.getElementById('wallet-transaction-list');
    const walletWithdrawBtn = document.getElementById('wallet-withdraw-btn');
    const addAccountBtn = document.getElementById('add-account-btn');
    const addAccountModal = document.getElementById('add-account-modal');
    const addAccountForm = document.getElementById('add-account-form');
    const setPrimaryAccountCheckbox = document.getElementById('set-primary-account-toggle');
    const viewAccountModal = document.getElementById('view-account-modal');
    const viewBankName = document.getElementById('view-bank-name');
    const viewAccountHolder = document.getElementById('view-account-holder');
    const viewAccountNumber = document.getElementById('view-account-number');
    const viewRoutingNumber = document.getElementById('view-routing-number');
    const viewAccountType = document.getElementById('view-account-type');
    const viewIsPrimary = document.getElementById('view-is-primary');
    const deleteAccountBtn = document.getElementById('delete-account-btn');
    const allModalCloseButtons = document.querySelectorAll('.modal-close-button');
    const allModalOverlays = document.querySelectorAll('.modal-overlay');
    const withdrawModal = document.getElementById('withdraw-modal');
    const withdrawAmountInput = document.getElementById('withdraw-amount');
    const maxWithdrawBalanceEl = document.getElementById('max-withdraw-balance');
    const withdrawMethodSelect = document.getElementById('withdraw-method');
    const cryptoWithdrawalSection = document.getElementById('crypto-withdrawal-section');
    const bankWithdrawalSection = document.getElementById('bank-withdrawal-section');
    const withdrawalCodeInput = document.getElementById('withdrawal-code');
    const submitWithdrawalBtn = document.getElementById('submit-withdrawal');
    const portModal = document.getElementById('port-details-modal');
    const paymentModal = document.getElementById('payment-modal');
    const paymentModalTitle = document.getElementById('payment-modal-title');
    const paymentAmountInput = document.getElementById('payment-amount');
    const payWithCryptoBtn = document.getElementById('pay-with-crypto');
    const payWithCardBtn = document.getElementById('pay-with-card');
    const cryptoPaymentSection = document.getElementById('crypto-payment-section');
    const cardPaymentSection = document.getElementById('card-payment-section');
    const proceedToPayCryptoBtn = document.getElementById('proceed-to-pay-crypto');
    const proceedToPayCardBtn = document.getElementById('proceed-to-pay-card');
    const btcAddressDisplay = document.getElementById('btc-address-display');
    const investSteps = document.querySelectorAll('.invest-step');
    const selectPackageBtns = document.querySelectorAll('.select-package-btn');
    const investNavBtns = document.querySelectorAll('.invest-nav-btn');
    // Logic for the "MAX" button in Withdrawal Modal
    const btnMaxAmount = document.getElementById('btn-max-amount');
    
    if (btnMaxAmount && withdrawAmountInput) {
        btnMaxAmount.addEventListener('click', () => {
            // Get current balance safely
            const maxVal = currentUserData.availableBalance || 0;
            // Set input value
            withdrawAmountInput.value = maxVal.toFixed(2);
        });
    }

    // Optional: Visual feedback while typing
    withdrawAmountInput.addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        const max = currentUserData.availableBalance || 0;
        
        if (val > max) {
            e.target.style.borderColor = '#dc3545'; // Red border
            e.target.style.color = '#dc3545'; // Red text
        } else {
            e.target.style.borderColor = ''; // Reset
            e.target.style.color = ''; // Reset
        }
    });
    // MODIFICATION: Changed button ID from 'confirm-and-pay-btn'
    const submitApplicationBtn = document.getElementById('submit-application-btn');
    const termsCheckbox = document.getElementById('terms-checkbox');
    
    const profileForm = document.getElementById('profile-form');
    const profilePictureImg = document.getElementById('profile-picture-img');
    const profilePictureUpload = document.getElementById('profile-picture-upload');
    const kycUploadSection = document.getElementById('kyc-upload-section');
    const kycPendingSection = document.getElementById('kyc-pending-section');
    const kycVerifiedSection = document.getElementById('kyc-verified-section');
    const kycDocumentUpload = document.getElementById('kyc-document-upload');
    const kycFileName = document.getElementById('kyc-file-name');
    const submitKycBtn = document.getElementById('submit-kyc-btn');
    const referralCountEl = document.getElementById('referral-count');
    const referralEarningsEl = document.getElementById('referral-earnings');
    const referralLinkInput = document.getElementById('referral-link-input');
    const copyReferralLinkBtn = document.getElementById('copy-referral-link-btn');
    const profileTabLinks = document.querySelectorAll('.profile-tab-link');
    const profileTabContents = document.querySelectorAll('.profile-tab-content > div');
    const chartTotalEl = document.getElementById('chart-total-earnings');
    const chartComparisonEl = document.getElementById('chart-comparison');
    const timespanBtns = document.querySelectorAll('.timespan-btn');
    const kpiActivePortsEl = document.getElementById('kpi-active-ports');
    const kpiKwhDeliveredEl = document.getElementById('kpi-kwh-delivered');
    const kpiChargingSessionsEl = document.getElementById('kpi-charging-sessions');
    const kpiCo2OffsetEl = document.getElementById('kpi-co2-offset');

    function showToast(message, type = 'error') {
        const container = document.getElementById('toast-container');
        if (!container) return; // Failsafe if the container isn't in the HTML
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;

        container.appendChild(toast);
        
        // Trigger the animation to slide in
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        // Set a timer to remove the toast after 5 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            // Wait for the slide-out animation to finish before removing from the DOM
            toast.addEventListener('transitionend', () => toast.remove());
        }, 5000);
    }
    
    let allPortsData = {}, currentUserData = {}, linkedAccountsData = [], paymentSettings = {}, kycFile = null;
    let earningsChart = null;
    
    // This function remains the same as it's for deposits, not investment applications.
    async function callUpdateBalanceFunction(activityId) { /* ... same as before ... */ }

    // --- 2. HELPERs FUNCTIONS (No changes here) ---
    function formatTimestamp(d) { return new Intl.DateTimeFormat(undefined,{month:'short',day:'numeric',year:'numeric'}).format(d.toDate()); }
    function compressAndEncodeImage(file) { return new Promise((resolve, reject) => { const MAX_WIDTH = 800; const MAX_HEIGHT = 800; const JPEG_QUALITY = 0.8; const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (event) => { const img = new Image(); img.src = event.target.result; img.onload = () => { const canvas = document.createElement('canvas'); let width = img.width; let height = img.height; if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } } canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', JPEG_QUALITY)); }; img.onerror = reject; }; reader.onerror = reject; }); }
    function createActivityItem(d) {
        let i = document.createElement('li');
        i.className = 'activity-item';
        let c = 'fa-solid fa-question', b = '#e3e8f7', o = '#3b5bdb', a = '', p = '';
        let s = d.status ? `<span class="activity-status" style="color:#f39c12;font-weight:500;">${d.status}</span>` : formatTimestamp(d.timestamp);
        switch (d.type) {
            case 'earning': c = 'fa-solid fa-dollar-sign'; b = '#e0f5ea'; o = '#158a4a'; a = 'positive'; p = '+'; break;
            case 'withdrawal': c = 'fa-solid fa-arrow-right-to-bracket'; b = '#f7e3e3'; o = '#db3b3b'; a = 'negative'; p = '-'; break;
            case 'deposit': c = 'fa-solid fa-plus'; b = '#e0f0ff'; o = '#0055cc'; a = 'positive'; p = '+'; break;
            case 'investment': c = 'fa-solid fa-charging-station'; b = '#e3e8f7'; o = '#3b5bdb'; a = 'negative'; p = '-'; break;
            case 'maintenance': c = 'fa-solid fa-screwdriver-wrench'; b = '#eef0f3'; o = '#6c757d'; break;
        }
        let f = d.amount ? `${p}$${Math.abs(d.amount).toFixed(2)}` : (d.type === 'maintenance' ? '' : '$0.00');
        let desc = (d.description || '').replace('Deposit Request', 'Deposit').replace(' (Resolved)', '<span style="color:#158a4a;"> (Resolved)</span>').replace('Payment for', 'Package Payment:').split(' ').map(word => word.length > 30 ? `${word.substring(0, 9)}...${word.substring(word.length - 12)}` : word).join(' ');
        i.innerHTML = `<div class="activity-icon" style="background-color:${b};color:${o};"><i class="${c}"></i></div><div class="activity-details"><p>${desc}</p><span>${s}</span></div><p class="activity-amount ${a}">${f}</p>`;
        return i;
    }
    function createPortItem(id, d) { 
        let i = document.createElement('div');
        i.className = 'port-item';
        i.dataset.portId = id;
        
        let s = d.status || 'Unknown',
            l = d.locationName || 'Pending Location',
            p = d.portIdentifier || 'Pending ID',
            m = parseFloat(d.monthlyEarnings) || 0, 
            u = d.utilization || 0,
            c = `status-${s.toLowerCase().replace(/ /g,'-')}`;

        let bottomContent = '';
        
        // CASE 1: Admin has approved app, waiting for user to sign contract/pay via email
        if (s === 'Awaiting Payment') {
            bottomContent = `
                <div class="port-actions" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                    <div style="background-color: #f0fdf4; border: 1px solid #bbf7d0; padding: 12px; border-radius: 6px; color: #166534; font-size: 0.9rem;">
                        <p style="margin-bottom: 5px; font-weight: 600;"><i class="fa-solid fa-check-circle"></i> Application Approved!</p>
                        <p>We have sent the investment contract to your email. Please review and sign to finalize your investment.</p>
                    </div>
                </div>
            `;
        } 
        // CASE 2: User just submitted, Admin hasn't looked at it yet
        else if (s === 'Application Submitted') {
            bottomContent = `
                <div class="port-actions" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                     <div style="background-color: #eff6ff; border: 1px solid #bfdbfe; padding: 12px; border-radius: 6px; color: #1e40af; font-size: 0.9rem;">
                        <p style="margin-bottom: 5px; font-weight: 600;"><i class="fa-solid fa-clock"></i> Under Review</p>
                        <p>Our team is reviewing your application. You will receive an email shortly.</p>
                    </div>
                </div>
            `;
        } 
        // CASE 3: Active, Under Construction, Inactive (Show Stats)
        else {
            bottomContent = `
                <div class="port-info-grid">
                    <div class="port-info-item">
                        <span class="port-label">Status</span>
                        <span class="port-status ${c}">${s}</span>
                    </div>
                    <div class="port-info-item">
                        <span class="port-label">Monthly Earnings</span>
                        <span class="port-value">$${m.toFixed(2)}</span>
                    </div>
                    <div class="port-info-item">
                        <span class="port-label">Utilization</span>
                        <span class="port-value">${u}%</span>
                    </div>
                </div>
            `;
        }

        i.innerHTML = `
            <div class="port-details">
                <h3 class="port-location">${l}</h3>
                <p class="port-id">${p}</p>
            </div>
            ${bottomContent}
        `;
        return i;
    }
    function createLinkedAccountItem(d) { let i=document.createElement('li');i.className='linked-account-item';i.dataset.accountId=d.id;i.innerHTML=`<i class="fa-solid fa-building-columns"></i><div class="account-details"><p>${d.bankName} - ${d.accountType} **** ${d.accountNumberLastFour}</p>${d.isPrimary?'<span>Primary Account</span>':''}</div>`;return i;}
    function generateRandomPortId() { const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'; const randomLetter = letters.charAt(Math.floor(Math.random() * letters.length)); const randomNumber = Math.floor(10 + Math.random() * 990); return `Port #${randomLetter}-${randomNumber}`; }
    
    // --- 3. DATA FETCHING (No changes here) ---
    function fetchAllData(user) { const uRef=db.collection('users').doc(user.uid);Promise.all([uRef.get(),uRef.collection('activity').orderBy('timestamp','desc').get(),uRef.collection('ports').orderBy('purchaseDate', 'desc').get(),uRef.collection('linkedAccounts').orderBy('isPrimary','desc').get(), db.collection('settings').doc('payment').get()]).then(([userDoc,actSnap,portSnap,accSnap, paymentSettingsDoc])=>{if(userDoc.exists){currentUserData=userDoc.data(); setupChatListener(user.uid);userNameDesktop.textContent=currentUserData.firstName||'User';userNameMobile.textContent=currentUserData.firstName||'User';let bal=(currentUserData.availableBalance||0).toFixed(2);balanceAmountEl.textContent=bal;walletBalanceEl.textContent=bal;maxWithdrawBalanceEl.textContent=bal;balanceSubtitleEl.textContent=`$${(currentUserData.monthlyEarnings||0).toFixed(2)} earnings this month`;
    // Populate the new KPI cards
            const activePortsCount = portSnap.docs.filter(doc => doc.data().status === 'Active').length;
            
            if (kpiActivePortsEl) kpiActivePortsEl.textContent = activePortsCount;
            if (kpiKwhDeliveredEl) kpiKwhDeliveredEl.textContent = (currentUserData.monthlyKwhDelivered || 0).toFixed(1);
            if (kpiChargingSessionsEl) kpiChargingSessionsEl.textContent = currentUserData.monthlySessions || 0;
            if (kpiCo2OffsetEl) kpiCo2OffsetEl.textContent = (currentUserData.monthlyCo2Offset || 0).toFixed(2);
    document.getElementById('profile-first-name').value=currentUserData.firstName||'';document.getElementById('profile-last-name').value=currentUserData.lastName||'';document.getElementById('profile-email').value=user.email;document.getElementById('profile-address').value=currentUserData.address?.street||'';document.getElementById('profile-city').value=currentUserData.address?.city||'';document.getElementById('profile-state').value=currentUserData.address?.state||'';document.getElementById('profile-zip').value=currentUserData.address?.zip||'';document.getElementById('profile-country').value=currentUserData.region||'';if(currentUserData.profilePictureUrl){profilePictureImg.src=currentUserData.profilePictureUrl;}kycUploadSection.classList.toggle('hidden',currentUserData.kycStatus==='Pending'||currentUserData.kycStatus==='Verified');kycPendingSection.classList.toggle('hidden',currentUserData.kycStatus!=='Pending');kycVerifiedSection.classList.toggle('hidden',currentUserData.kycStatus!=='Verified');referralCountEl.textContent=currentUserData.referralCount||0;referralEarningsEl.textContent=`$${(currentUserData.referralEarnings||0).toFixed(2)}`;referralLinkInput.value=`chargepace.com/register.html?ref=${user.uid}` } if (paymentSettingsDoc.exists) { paymentSettings = paymentSettingsDoc.data(); } else { console.log("Payment settings not found!"); } activityListEl.innerHTML='';let rAct=actSnap.docs.slice(0,5);if(rAct.length===0){activityListEl.innerHTML='<li style="padding:20px 0;text-align:center;color:var(--text-light);">No recent activity.</li>';}else{rAct.forEach(doc=>activityListEl.appendChild(createActivityItem(doc.data())));}walletTransactionListEl.innerHTML='';let fAct=actSnap.docs.filter(doc=>['earning','deposit','withdrawal', 'investment', 'maintenance'].includes(doc.data().type));if(fAct.length===0){walletTransactionListEl.innerHTML='<li style="padding:20px;text-align:center;color:var(--text-light);">No transactions found.</li>';}else{fAct.forEach(doc=>walletTransactionListEl.appendChild(createActivityItem(doc.data())));}portsListEl.innerHTML='';allPortsData={};if(portSnap.empty){portsListEl.innerHTML='<p style="text-align:center;color:var(--text-light);padding:20px;">You do not own any charging ports yet.</p>';}else{portSnap.forEach(doc=>{allPortsData[doc.id]=doc.data();portsListEl.appendChild(createPortItem(doc.id,doc.data()));});}linkedAccountsListEl.innerHTML='';linkedAccountsData=[];if(accSnap.empty){linkedAccountsListEl.innerHTML='<li style="padding:20px;text-align:center;color:var(--text-light);">No linked accounts.</li>';}else{accSnap.forEach(doc=>{let d={id:doc.id,...doc.data()};linkedAccountsData.push(d);linkedAccountsListEl.appendChild(createLinkedAccountItem(d));});} initializeChart(user); body.style.transition='opacity 0.5s';body.style.opacity='1';}).catch(err=>console.error("Error fetching all data:",err));}
    
    // New function to listen for live balance updates
    function setupRealtimeUserListener(user) {
        db.collection('users').doc(user.uid).onSnapshot((doc) => {
            if (doc.exists) {
                const data = doc.data();
                
                // Update Balance
                const bal = (data.availableBalance || 0).toFixed(2);
                const walletBal = document.getElementById('wallet-balance');
                const homeBal = document.querySelector('#home-content .balance-amount p');
                const maxWithdraw = document.getElementById('max-withdraw-balance');
                
                if (walletBal) walletBal.textContent = bal;
                if (homeBal) homeBal.textContent = bal;
                if (maxWithdraw) maxWithdraw.textContent = bal;

                // Update Earnings Subtitles
                const earn = (data.monthlyEarnings || 0).toFixed(2);
                const subTitle = document.querySelector('.balance-subtitle p');
                if (subTitle) subTitle.textContent = `$${earn} earnings this month`;

                // Update KPIs
                if (document.getElementById('kpi-kwh-delivered')) 
                    document.getElementById('kpi-kwh-delivered').textContent = (data.monthlyKwhDelivered || 0).toFixed(1);
                if (document.getElementById('kpi-co2-offset'))
                    document.getElementById('kpi-co2-offset').textContent = (data.monthlyCo2Offset || 0).toFixed(2);
            }
        });
    }

    // --- 4. MODAL & FORM FUNCTIONS (Most functions remain the same) ---
    function openModal(el) { if (el) el.classList.remove('hidden'); }
    function closeModal(el) { if (el) el.classList.add('hidden'); }
    function openPortDetailsModal(portId) { 
        const portData = allPortsData[portId]; 
        if (!portData) { console.error("Port data not found for ID:", portId); return; } 
        document.getElementById('modal-port-location').textContent = portData.locationName || 'Unnamed Port'; 
        document.getElementById('modal-port-id').textContent = portData.portIdentifier || `#${portId.substring(0,6)}`; 
        const statusEl = document.getElementById('modal-port-status'); 
        statusEl.textContent = portData.status || 'Unknown'; 
        statusEl.className = 'port-status'; 
        const statusClass = `status-${(portData.status || 'unknown').toLowerCase().replace(/ /g, '-')}`; 
        statusEl.classList.add(statusClass); 
        document.getElementById('modal-activation-date').textContent = portData.activationDate ? formatTimestamp(portData.activationDate) : 'Pending'; 
        document.getElementById('modal-monthly-earnings').textContent = `$${(parseFloat(portData.monthlyEarnings) || 0).toFixed(2)}`; 
        document.getElementById('modal-lifetime-earnings').textContent = `$${(parseFloat(portData.lifetimeEarnings) || 0).toFixed(2)}`; 
        document.getElementById('modal-utilization').textContent = `${portData.utilization || 0}%`; 
         
        openModal(portModal); 
    }
    async function handleSubmitAddAccount(e) { e.preventDefault();const btn=addAccountForm.querySelector('button[type="submit"]');btn.disabled=true;btn.textContent='Saving...';try{const user=auth.currentUser;const ref=db.collection('users').doc(user.uid).collection('linkedAccounts');const data={bankName:addAccountForm['add-bank-name'].value.trim(),accountHolderName:addAccountForm['add-account-holder-name'].value.trim(),accountNumber:addAccountForm['add-account-number'].value.trim(),routingNumber:addAccountForm['add-routing-number'].value.trim(),accountType:addAccountForm['add-account-type'].value,isPrimary:setPrimaryAccountCheckbox.checked,accountNumberLastFour:addAccountForm['add-account-number'].value.trim().slice(-4)};if(data.isPrimary){const batch=db.batch();const q=await ref.where('isPrimary','==',true).get();q.forEach(doc=>batch.update(doc.ref,{isPrimary:false}));const newRef=ref.doc();batch.set(newRef,data);await batch.commit();}else{await ref.add(data);}alert('Bank account added successfully!');closeModal(addAccountModal);fetchAllData(user);}catch(err){console.error("Error adding bank account:",err);alert("An error occurred.");}finally{btn.disabled=false;btn.textContent='Add Account';}}
    function openViewAccountModal(id) { const acc=linkedAccountsData.find(a=>a.id===id);if(!acc)return;viewBankName.textContent=acc.bankName;viewAccountHolder.textContent=acc.accountHolderName;viewAccountNumber.textContent=acc.accountNumber;viewRoutingNumber.textContent=acc.routingNumber;viewAccountType.textContent=acc.accountType;viewIsPrimary.textContent=acc.isPrimary?'Yes':'No';deleteAccountBtn.dataset.accountId=id;openModal(viewAccountModal);}
    async function handleDeleteAccount(e) { const id=e.target.dataset.accountId;if(!id)return;if(confirm('Are you sure you want to delete this bank account?')){try{const user=auth.currentUser;await db.collection('users').doc(user.uid).collection('linkedAccounts').doc(id).delete();alert('Account deleted successfully.');closeModal(viewAccountModal);fetchAllData(user);}catch(err){console.error("Error deleting account:",err);alert("Could not delete the account.");}}}
    async function handleSubmitWithdrawal(e) {
    e.preventDefault();
    const btn = submitWithdrawalBtn;
    const amt = parseFloat(withdrawAmountInput.value);
    const method = withdrawMethodSelect.value;
    const code = withdrawalCodeInput.value.trim();

    // Perform initial client-side checks for a better user experience
    if (isNaN(amt) || amt <= 0) {
        return showToast("Please enter a valid withdrawal amount.");
    }
    if (amt > currentUserData.availableBalance) {
        return showToast("Amount exceeds available balance.");
    }
    if (!method) {
        return showToast("Please select a withdrawal method.");
    }
    if (!code || code.length !== 6) {
        return showToast("Please enter your 6-digit withdrawal code.");
    }

    // Gather the destination details
    let destinationDetails = {};
    if (method === 'crypto') {
        const currency = document.getElementById('crypto-currency').value;
        const address = document.getElementById('crypto-address').value.trim();
        if (!currency || !address) return showToast("Please select a crypto and enter a wallet address.");
        destinationDetails = { method: 'Crypto', currency, address };
    } else if (method === 'bank') {
        const accountId = document.getElementById('linked-account-select').value;
        if (!accountId) return showToast("Please select a linked bank account.");
        const selectedAccount = linkedAccountsData.find(acc => acc.id === accountId);
        destinationDetails = {
            method: 'Bank Transfer',
            bankName: selectedAccount.bankName,
            accountHolder: selectedAccount.accountHolderName,
            accountLastFour: selectedAccount.accountNumberLastFour
        };
    }

    // Update UI to show processing
    btn.disabled = true;
    btn.textContent = 'Verifying...';

    try {
        const user = auth.currentUser;
        if (!user) throw new Error("You are not signed in.");

        // Get the user's authentication token to prove their identity to our secure function
        const authToken = await user.getIdToken();

        // THIS IS THE KEY CHANGE: Call our secure Netlify Function
        const response = await fetch('/.netlify/functions/submit-withdrawal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                authToken: authToken,
                amount: amt,
                details: destinationDetails,
                code: code // Send the code the user entered for validation
            })
        });
        
        const result = await response.json();

        // If the server responded with an error (e.g., code was wrong), show it
        if (!response.ok) {
            throw new Error(result.error || 'An unknown error occurred.');
        }

        // If the request was successful
        showToast('Withdrawal request submitted successfully!', 'success');
        closeModal(withdrawModal);
        fetchAllData(user); // Refresh data to show the new pending transaction

    } catch (err) {
        console.error("Error submitting withdrawal:", err);
        // Display the specific error from our function (e.g., "The withdrawal code is incorrect.")
        showToast(err.message);
    } finally {
        // Always reset the button
        btn.disabled = false;
        btn.textContent = 'Withdraw';
    }
}
    async function handleProfileUpdate(e) {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.textContent = 'Saving...';

    try {
        const user = auth.currentUser;
        const ref = db.collection('users').doc(user.uid);
        let picUrl = currentUserData.profilePictureUrl || null;
        const file = profilePictureUpload.files[0];

        if (file) {
            // Specific validation for file size before processing
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                showToast("Image file is too large. Please use a file under 5MB.");
                btn.disabled = false;
                btn.textContent = 'Save Changes';
                return;
            }
            try {
                picUrl = await compressAndEncodeImage(file);
            } catch (compressionError) {
                console.error("Error compressing image:", compressionError);
                showToast("The selected image could not be processed. Please try another.");
                btn.disabled = false;
                btn.textContent = 'Save Changes';
                return;
            }
        }
        
        await ref.update({
            firstName: document.getElementById('profile-first-name').value,
            lastName: document.getElementById('profile-last-name').value,
            address: {
                street: document.getElementById('profile-address').value,
                city: document.getElementById('profile-city').value,
                state: document.getElementById('profile-state').value,
                zip: document.getElementById('profile-zip').value
            },
            profilePictureUrl: picUrl
        });

        showToast('Profile updated successfully!', 'success'); // Success toast!
        fetchAllData(user);

    } catch (err) {
        console.error("Error updating profile:", err);
        // Check for specific Firebase errors if you want, e.g., permission denied
        if (err.code === 'permission-denied') {
            showToast("You do not have permission to perform this action.");
        } else {
            showToast("An unexpected server error occurred. Please try again.");
        }
    } finally {
        btn.disabled = false;
        btn.textContent = 'Save Changes';
    }
}
    async function handleKycUpload() { if (!kycFile) return alert('Please choose a file.'); const btn = submitKycBtn; btn.disabled = true; btn.textContent = 'Uploading...'; try { const user = auth.currentUser; let docUrl; try { docUrl = await compressAndEncodeImage(kycFile); } catch (compressionError) { console.error("Error compressing KYC image:", compressionError); alert("The selected ID image could not be processed."); btn.disabled = false; btn.textContent = 'Upload for Verification'; return; } if (docUrl.length > 1048487) { alert("The ID image is too large even after compression. Please use a smaller file."); btn.disabled = false; btn.textContent = 'Upload for Verification'; return; } await db.collection('users').doc(user.uid).update({ kycDocumentUrl: docUrl, kycStatus: 'Pending' }); alert('KYC document submitted!'); fetchAllData(user); } catch (err) { console.error("Error submitting KYC:", err); alert("An error occurred while submitting your document."); } finally { btn.disabled = false; btn.textContent = 'Upload for Verification'; } }
    
    // This function for handling deposit payments remains, as the modal is still used for deposits.
    async function handlePaymentSubmission(paymentMethod) {
        const user = auth.currentUser;
        if (!user) return alert("You are not logged in.");
        
        const context = paymentModal.dataset.paymentContext;
        const amount = parseFloat(paymentAmountInput.value);
        if (isNaN(amount) || amount <= 0) return alert("Invalid amount.");

        const btn = (paymentMethod === 'crypto') ? proceedToPayCryptoBtn : proceedToPayCardBtn;
        btn.disabled = true;
        btn.textContent = 'Processing...';

        const paymentWindow = window.open('', 'paymentWindow', `width=500,height=700`);

        try {
            let paymentUrl = '';
            
            if (context === 'deposit') {
                const activityRef = await db.collection('users').doc(user.uid).collection('activity').add({
                    type: 'deposit',
                    status: 'Pending',
                    description: `Deposit via ${paymentMethod}`,
                    amount: amount,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                if (paymentMethod === 'crypto') {
                    paymentUrl = paymentSettings.nowpayments_link;
                } else if (paymentMethod === 'card') {
                    paymentUrl = paymentSettings.stripe_standard_port_link; // Fallback or your general deposit link
                }
                
                await callUpdateBalanceFunction(activityRef.id);
                alert('Your deposit has been recorded and your balance will be updated shortly.');
            }

            if (paymentUrl && paymentWindow) {
                paymentWindow.location.href = paymentUrl;
            } else if (!paymentUrl) {
                if(paymentWindow) paymentWindow.close();
                alert('Payment configuration is missing. Please contact support.');
            }

            closeModal(paymentModal);
            fetchAllData(user);

        } catch (err) {
            console.error(`Error processing ${context}:`, err);
            alert(`An error occurred during your ${context}. Please try again.`);
            if(paymentWindow) paymentWindow.close();
        } finally {
            btn.disabled = false;
            btn.textContent = 'Proceed to Pay';
        }
    }
    
    // ================== JAVASCRIPT LOGIC FOR NEW INVESTMENT FLOW ==================
    let investmentState = {};
    function goToInvestStep(stepNumber) { investSteps.forEach(s => s.classList.add('hidden')); document.getElementById(`invest-step-${stepNumber}`)?.classList.remove('hidden'); }

    // NEW FUNCTION: Handles submitting the application to Firestore
    async function handleApplicationSubmit() {
        const btn = submitApplicationBtn;
        if (!termsCheckbox.checked) {
            return alert('You must agree to the Investment Terms & Conditions to proceed.');
        }
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Submitting...';

        try {
            const user = auth.currentUser;
            if (!user) {
                alert("You are not logged in. Redirecting to login page.");
                window.location.href = 'login.html';
                return;
            }

            // Create a new port document with the application details
            await db.collection('users').doc(user.uid).collection('ports').add({
                // Data from Step 1
                package: investmentState.package,
                price: investmentState.price,
                // Data from Step 2
                region: investmentState.region,
                legalName: investmentState.legalName,
                phone: investmentState.phone,
                address: investmentState.address,
                source: investmentState.source,
                // System-generated data
                status: 'Application Submitted', // This is the key status for the admin
                purchaseDate: firebase.firestore.FieldValue.serverTimestamp(),
                locationName: 'Pending Application Review',
                portIdentifier: 'Pending',
                monthlyEarnings: 0,
                lifetimeEarnings: 0,
                utilization: 0
            });
            
            // Go to the final confirmation step
            goToInvestStep(4);

        } catch (error) {
            console.error("Error submitting application:", error);
            alert("An error occurred while submitting your application. Please try again.");
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Submit Application';
        }
    }

    // --- 5. CHART LOGIC (No changes here) ---
    async function getEarningsDataForPeriod(user, days) { const now = new Date(); const currentPeriodEnd = new Date(now); const currentPeriodStart = new Date(new Date().setDate(now.getDate() - days)); const previousPeriodEnd = new Date(currentPeriodStart); previousPeriodEnd.setMilliseconds(previousPeriodEnd.getMilliseconds() - 1); const previousPeriodStart = new Date(new Date(previousPeriodEnd).setDate(previousPeriodEnd.getDate() - days)); const earningsRef = db.collection('users').doc(user.uid).collection('activity'); const currentPeriodQuery = earningsRef.where('type', '==', 'earning').where('timestamp', '>=', currentPeriodStart).where('timestamp', '<=', currentPeriodEnd).get(); const previousPeriodQuery = earningsRef.where('type', '==', 'earning').where('timestamp', '>=', previousPeriodStart).where('timestamp', '<', previousPeriodEnd).get(); const [currentSnap, previousSnap] = await Promise.all([currentPeriodQuery, previousPeriodQuery]); const processSnapshot = (snapshot, startDate, numDays) => { const dailyEarnings = Array(numDays + 1).fill(0); snapshot.forEach(doc => { const data = doc.data(); if (!data.timestamp || typeof data.amount !== 'number') return; const earningDate = data.timestamp.toDate(); const dayIndex = Math.floor((earningDate - startDate) / (1000 * 60 * 60 * 24)); if (dayIndex >= 0 && dayIndex <= numDays) { dailyEarnings[dayIndex] += data.amount; } }); const cumulativeEarnings = dailyEarnings.reduce((acc, val, index) => { acc.push((acc[index - 1] || 0) + val); return acc; }, []); return cumulativeEarnings; }; const currentData = processSnapshot(currentSnap, currentPeriodStart, days); const previousData = processSnapshot(previousSnap, previousPeriodStart, days); const todayIndex = currentData.length - 1; const previousValueAtSamePoint = previousData[todayIndex] || 0; const totalCurrent = currentData.length > 0 ? currentData[todayIndex] : 0; const comparison = totalCurrent - previousValueAtSamePoint; return { currentData, previousData, totalCurrent, comparison }; }
    function renderChart(chartData) {
        const options = {
            series: [{ name: 'Current', data: chartData.currentData }, { name: 'Previous', data: chartData.previousData }],
            chart: { height: 220, type: 'line', toolbar: { show: false }, zoom: { enabled: false }, sparkline: { enabled: true } },
            colors: ['#1e1e1e', '#e0e0e0'],
            stroke: { curve: 'smooth', width: 3 },
            grid: { show: true, borderColor: '#e0e0e0', strokeDashArray: 4, position: 'back', xaxis: { lines: { show: false } }, yaxis: { lines: { show: true } } },
            xaxis: { labels: { show: false }, axisBorder: { show: false }, axisTicks: { show: false }, tooltip: { enabled: false } },
            yaxis: { labels: { show: false } },
            tooltip: { enabled: true, x: { show: false }, custom: function({ series, seriesIndex, dataPointIndex, w }) { return ''; }, crosshairs: { show: true, stroke: { color: '#b6b6b6', width: 1, dashArray: 4, }, }, },
            legend: { show: false },
            noData: { text: 'No earnings data for this period.', align: 'center', verticalAlign: 'middle', style: { color: '#6c757d', fontSize: '14px', fontFamily: 'Inter' } }
        };
        if (earningsChart) { earningsChart.updateOptions(options); } else { earningsChart = new ApexCharts(document.querySelector("#earnings-chart"), options); earningsChart.render(); }
    }
    async function updateChart(user, range) { let days; switch(range) { case '6M': days = 180; break; case '1Y': days = 365; break; default: days = 30; } const chartData = await getEarningsDataForPeriod(user, days); renderChart(chartData); }
    async function initializeChart(user) { if(!user) return; timespanBtns.forEach(btn => { btn.addEventListener('click', () => { timespanBtns.forEach(b => b.classList.remove('active')); btn.classList.add('active'); updateChart(user, btn.dataset.range); }); }); await updateChart(user, '30D'); }


    // --- SUPPORT CHAT LOGIC ---
    const supportChatForm = document.getElementById('support-chat-form');
    const chatMessageInput = document.getElementById('chat-message-input');
    const chatWindow = document.getElementById('chat-window');
    const newConversationBtn = document.getElementById('new-conversation-btn');
    let chatListener = null; // To manage the real-time listener

    // Helper to format timestamps for chat messages (e.g., "3:45 PM")
    function formatChatTimestamp(fbTimestamp) {
        if (!fbTimestamp || typeof fbTimestamp.toDate !== 'function') return '';
        const date = fbTimestamp.toDate();
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
    }

    // Renders the chat messages into the chat window
    function renderSupportChat(messages = []) {
        if (!chatWindow) return;
        chatWindow.innerHTML = ''; // Clear existing messages
        
        // Handle empty chat
        if (messages.length === 0) {
            chatWindow.innerHTML = '<p class="empty-state" style="padding: 20px; text-align: center; color: var(--text-light);">Send a message to start the conversation.</p>';
            return;
        }

        messages.forEach(msg => {
            // Determine if the message is from the user, an admin, or the system
            const bubbleClass = msg.sender || 'user'; 
            const formattedTime = formatChatTimestamp(msg.timestamp);

            const bubbleHtml = `
                <div class="chat-bubble ${bubbleClass}">
                    <p>${msg.text}</p>
                    <span>${formattedTime}</span>
                </div>
            `;
            chatWindow.innerHTML += bubbleHtml;
        });
        
        // Automatically scroll to the newest message
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    
    // This function will be called from your main fetchAllData function
    function setupChatListener(uid) {
        // Unsubscribe from any previous chat listener to prevent memory leaks
        if (chatListener) {
            chatListener();
        }
        // Listen for new messages in real-time
        const chatRef = db.collection('users').doc(uid).collection('supportChat').orderBy('timestamp', 'asc');
        chatListener = chatRef.onSnapshot(snapshot => {
            renderSupportChat(snapshot.docs.map(doc => doc.data()));
        });
        
        // Also, check the user's support ticket status
        if (currentUserData.hasSupportTicket) {
            chatMessageInput.disabled = false;
            supportChatForm.querySelector('button').disabled = false;
            chatMessageInput.placeholder = "Type your message...";
            newConversationBtn.classList.add('hidden');
        } else {
            chatMessageInput.disabled = true;
            supportChatForm.querySelector('button').disabled = true;
            chatMessageInput.placeholder = "This conversation has been resolved.";
            newConversationBtn.classList.remove('hidden');
        }
    }

    // Add this line inside your `fetchAllData` function, right after the line `currentUserData=userDoc.data();`
    // It will look like this:
    // if(userDoc.exists){ currentUserData=userDoc.data(); setupChatListener(user.uid); ... }
    
    // Add an event listener for submitting the chat form
    if (supportChatForm) {
        supportChatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = chatMessageInput.value.trim();
            const user = auth.currentUser;

            if (messageText && user) {
                const isNewTicket = !currentUserData.hasSupportTicket;
                const userMessage = {
                    text: messageText,
                    sender: 'user',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    const userRef = db.collection('users').doc(user.uid);
                    await db.runTransaction(async (transaction) => {
                        // If this is the start of a new chat, add a system message
                        if (isNewTicket) {
                            const systemMessage = {
                                text: `--- New Conversation Started on ${new Date().toLocaleDateString()} ---`,
                                sender: 'system',
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            transaction.set(userRef.collection('supportChat').doc(), systemMessage);
                        }
                        // Add the user's actual message
                        transaction.set(userRef.collection('supportChat').doc(), userMessage);
                        // Mark the ticket as active
                        transaction.update(userRef, { hasSupportTicket: true });
                    });
                    chatMessageInput.value = ''; // Clear input on success
                } catch (error) {
                    console.error("Error sending chat message:", error);
                    alert("Sorry, your message could not be sent.");
                }
            }
        });
    }

    // Add event listener for the "Start New Conversation" button
    if (newConversationBtn) {
        newConversationBtn.addEventListener('click', () => {
            newConversationBtn.classList.add('hidden');
            chatMessageInput.disabled = false;
            chatMessageInput.placeholder = "Type your message...";
            supportChatForm.querySelector('button').disabled = false;
            chatMessageInput.focus();
        });
    }

    // Finally, modify your handleLogout function to unsubscribe from the chat listener
    // const handleLogout = () => { if (chatListener) chatListener(); auth.signOut()... }
    

    // --- 6. EVENT LISTENERS (Updated for new investment flow) ---
    function handleNavigation(e) { e.preventDefault();const targetId=e.currentTarget.dataset.target;if(!targetId)return;pageContents.forEach(c=>c.classList.add('hidden'));document.getElementById(targetId)?.classList.remove('hidden');navLinks.forEach(n=>n.classList.remove('active'));document.querySelectorAll(`[data-target="${targetId}"]`).forEach(l=>l.classList.add('active'));}
    function handleProfileTabNavigation(e) { const id=e.currentTarget.dataset.target;profileTabLinks.forEach(l=>l.classList.remove('active'));e.currentTarget.classList.add('active');profileTabContents.forEach(c=>c.id!==id?c.classList.add('hidden'):c.classList.remove('hidden'));}
    const handleLogout = () => { if (chatListener) chatListener(); auth.signOut().then(() => { window.location.href = 'login.html'; }); };
    auth.onAuthStateChanged(user => { if (user && user.emailVerified) { fetchAllData(user); setupRealtimeUserListener(user); } else { window.location.replace('login.html'); } });
    
    navLinks.forEach(link => link.addEventListener('click', handleNavigation));
    
    // Listener for Package Selection (Step 1)
    selectPackageBtns.forEach(btn => btn.addEventListener('click', (e) => { 
        investmentState.package = e.currentTarget.dataset.package; 
        investmentState.price = parseFloat(e.currentTarget.dataset.price); 
        // Pre-fill form if data exists from user profile
        document.getElementById('apply-legal-name').value = `${currentUserData.firstName || ''} ${currentUserData.lastName || ''}`.trim();
        document.getElementById('apply-address').value = currentUserData.address ? `${currentUserData.address.street || ''}, ${currentUserData.address.city || ''}, ${currentUserData.address.state || ''} ${currentUserData.address.zip || ''}, ${currentUserData.region || ''}`.trim() : '';
        goToInvestStep(2); 
    }));

    // Listener for Navigation Buttons within the Investment Wizard
    investNavBtns.forEach(btn => btn.addEventListener('click', (e) => { 
        const button = e.currentTarget; 
        const targetStep = button.dataset.targetStep; 
        const targetPage = button.dataset.targetPage; 

        // LOGIC WHEN MOVING FROM STEP 2 to STEP 3
        if (targetStep === '3') {
            // 1. Grab all data from the application form
            const legalName = document.getElementById('apply-legal-name').value.trim();
            const phone = document.getElementById('apply-phone-number').value.trim();
            const address = document.getElementById('apply-address').value.trim();
            const region = document.getElementById('region-select').value;
            const source = document.getElementById('apply-source').value;

            // 2. Validate the data
            if (!legalName || !phone || !address || !region) {
                return alert('Please fill out all required fields in the application form.');
            }

            // 3. Store data in our state object
            investmentState.legalName = legalName;
            investmentState.phone = phone;
            investmentState.address = address;
            investmentState.region = region;
            investmentState.source = source;

            // 4. Populate the summary page (Step 3)
            document.getElementById('summary-package-name').textContent = investmentState.package;
            document.getElementById('summary-total-cost').textContent = `$${investmentState.price.toFixed(2)}`;
            document.getElementById('summary-region').textContent = investmentState.region;
            document.getElementById('summary-legal-name').textContent = investmentState.legalName;
            document.getElementById('summary-phone').textContent = investmentState.phone;
            document.getElementById('summary-address').textContent = investmentState.address;
        } 
        
        if (targetStep) { goToInvestStep(targetStep); } 
        if (targetPage) { 
            const navElement = document.querySelector(`.nav-link[data-target="${targetPage}"], .sidebar-link[data-target="${targetPage}"]`); 
            if(navElement) navElement.click(); 
        } 
    }));
    
    // NEW: Listener for the final "Submit Application" button on Step 3
    if (submitApplicationBtn) {
        submitApplicationBtn.addEventListener('click', handleApplicationSubmit);
    }

    // --- Listeners for Deposit Modals (No change, these are for the wallet/deposit feature) ---
    depositButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            paymentModal.dataset.paymentContext = 'deposit';
            paymentModalTitle.textContent = 'Make a Deposit';
            paymentAmountInput.value = '';
            paymentAmountInput.readOnly = false;
            paymentAmountInput.placeholder = 'Enter amount (e.g., 500)';
            openModal(paymentModal);
        });
    });
    if (payWithCryptoBtn) { payWithCryptoBtn.addEventListener('click', () => { cryptoPaymentSection.classList.remove('hidden'); cardPaymentSection.classList.add('hidden'); paymentModal.dataset.paymentMethod = 'crypto'; }); }
    if (payWithCardBtn) { payWithCardBtn.addEventListener('click', () => { cardPaymentSection.classList.remove('hidden'); cryptoPaymentSection.classList.add('hidden'); paymentModal.dataset.paymentMethod = 'card'; }); }
    if (proceedToPayCryptoBtn) { proceedToPayCryptoBtn.addEventListener('click', () => handlePaymentSubmission('crypto')); }
    if (proceedToPayCardBtn) { proceedToPayCardBtn.addEventListener('click', () => handlePaymentSubmission('card')); }

    // --- All other existing listeners ---
    if (addAccountBtn) { addAccountBtn.addEventListener('click', () => { addAccountForm.reset(); openModal(addAccountModal); }); }
    if (addAccountForm) { addAccountForm.addEventListener('submit', handleSubmitAddAccount); }
    if (linkedAccountsListEl) { linkedAccountsListEl.addEventListener('click', e => { const item = e.target.closest('.linked-account-item'); if (item) { openViewAccountModal(item.dataset.accountId); } }); }
    if (deleteAccountBtn) { deleteAccountBtn.addEventListener('click', handleDeleteAccount); }
    if (portsListEl) { portsListEl.addEventListener('click', e => { const item = e.target.closest('.port-item'); if (item && item.dataset.portId) { openPortDetailsModal(item.dataset.portId); } }); }
    if (walletWithdrawBtn) { walletWithdrawBtn.addEventListener('click', () => openModal(withdrawModal)); }
    if (withdrawMethodSelect) { 
        withdrawMethodSelect.addEventListener('change', () => { 
            const selectedMethod = withdrawMethodSelect.value; 
            bankWithdrawalSection.classList.toggle('hidden', selectedMethod !== 'bank'); 
            cryptoWithdrawalSection.classList.toggle('hidden', selectedMethod !== 'crypto'); 
            
            // NEW: Logic to populate the linked accounts dropdown
            if (selectedMethod === 'bank') {
                const linkedAccountSelect = document.getElementById('linked-account-select');
                linkedAccountSelect.innerHTML = '<option value="" disabled selected>-- Select your bank account --</option>';
                if (linkedAccountsData && linkedAccountsData.length > 0) {
                    linkedAccountsData.forEach(acc => {
                        const isPrimary = acc.isPrimary ? ' (Primary)' : '';
                        linkedAccountSelect.innerHTML += `<option value="${acc.id}">${acc.bankName} - ****${acc.accountNumberLastFour}${isPrimary}</option>`;
                    });
                } else {
                    linkedAccountSelect.innerHTML = '<option value="" disabled>No bank accounts linked.</option>';
                }
            }
        }); 
    }
    if (submitWithdrawalBtn) { submitWithdrawalBtn.addEventListener('click', handleSubmitWithdrawal); }
    if (profileForm) { profileForm.addEventListener('submit', handleProfileUpdate); }
    if (profilePictureUpload) { profilePictureUpload.addEventListener('change', e => { const f = e.target.files[0]; if (f) { const r = new FileReader(); r.onload = ev => profilePictureImg.src = ev.target.result; r.readAsDataURL(f); } }); }
    if (kycDocumentUpload) { kycDocumentUpload.addEventListener('change', e => { kycFile = e.target.files[0]; if (kycFile) kycFileName.textContent = kycFile.name; }); }
    if (submitKycBtn) { submitKycBtn.addEventListener('click', handleKycUpload); }
    if (copyReferralLinkBtn) { copyReferralLinkBtn.addEventListener('click', () => { referralLinkInput.select(); document.execCommand('copy'); copyReferralLinkBtn.textContent = 'Copied!'; setTimeout(() => { copyReferralLinkBtn.textContent = 'Copy'; }, 2000); }); }
    if (profileTabLinks) { profileTabLinks.forEach(link => link.addEventListener('click', handleProfileTabNavigation)); }
    allModalCloseButtons.forEach(btn => { btn.addEventListener('click', (e) => { const modal = e.target.closest('.modal-overlay'); closeModal(modal); }); });
    allModalOverlays.forEach(overlay => { overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(overlay); }); });
    if (logoutButtonDesktop) logoutButtonDesktop.addEventListener('click', handleLogout);
    if (logoutButtonMobile) logoutButtonMobile.addEventListener('click', handleLogout);
});
</script>
</body>
</html>